<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>麻瓜吃菜鸟</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-11-09T16:00:26.265Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Joden He</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Rabbit MQ 安装</title>
    <link href="http://yoursite.com/2021/10/09/other/rabbit-mq-install/"/>
    <id>http://yoursite.com/2021/10/09/other/rabbit-mq-install/</id>
    <published>2021-10-09T06:37:32.000Z</published>
    <updated>2021-11-09T16:00:26.265Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Rabbit MQ 是由 Erlang 语言编写的，也正因如此，在安装 Rabbit MQ 之前需要安装 Erlang 。建议采用较新版的 Erlang，这样可以获得较多更新和改进，可以到官网 (<a href="https://www.erlang.org/downloads" target="_blank" rel="noopener">https://www.erlang.org/downloads</a>) 下载</p><h2 id="安装-Erlang"><a href="#安装-Erlang" class="headerlink" title="安装 Erlang"></a>安装 Erlang</h2><h3 id="安装前置依赖"><a href="#安装前置依赖" class="headerlink" title="安装前置依赖"></a>安装前置依赖</h3><blockquote><p>在安装 erlang 之前先安装下依赖文件(这一步不要忘掉了， 不然后面./configure的时候要报错)</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[joden@localhost workspace]$ sudo yum install gcc glibc-devel make ncurses-devel openssl-devel xmlto</span><br></pre></td></tr></table></figure><h3 id="下载源码包"><a href="#下载源码包" class="headerlink" title="下载源码包"></a>下载源码包</h3><p>进入 Erlang 下载网址，下载源码包</p><p><img src="/images/other/20211009144350.png" alt="Erlang 源码包下载"></p><h3 id="解压安装包，并配置安装目录"><a href="#解压安装包，并配置安装目录" class="headerlink" title="解压安装包，并配置安装目录"></a>解压安装包，并配置安装目录</h3><p>这里我们安装到 <code>/opt/erlang</code> 目录下:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[joden@localhost workspace]$ tar -zxvf otp_src_24.1.tar.gz</span><br><span class="line">[joden@localhost workspace]$ cd otp_src_24.1</span><br><span class="line">[joden@localhost otp_src_24.1]$ ./configure --prefix=/opt/erlang</span><br><span class="line">[joden@localhost otp_src_24.1]$</span><br></pre></td></tr></table></figure><h3 id="编译及安装"><a href="#编译及安装" class="headerlink" title="编译及安装"></a>编译及安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[joden@localhost otp_src_24.1]$ make</span><br><span class="line">[joden@localhost otp_src_24.1]$ sudo make install</span><br></pre></td></tr></table></figure><blockquote><p>如果在安装的过程中出现类似”No xxx found” 的提示，可根据提示信息安装相应的包，然后重新执行，直到提示安装完毕为止。</p></blockquote><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><p>修改 <code>/etc/profile</code> 配置文件，添加下面的环境变量:</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ERLANG_HOME=/opt/erlang</span><br><span class="line">export PATH=<span class="formula">$PATH:$</span>ERLANG_HOME/bin</span><br></pre></td></tr></table></figure><p>最后执行 <code>source /etc/profile</code> 命令让配置文件生效:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[joden@localhost otp_src_24.1]$ sudo vim /etc/profile</span><br><span class="line">[joden@localhost otp_src_24.1]$ source /etc/profile</span><br></pre></td></tr></table></figure><p>可以输入 <code>erl</code> 命令来验证 Erlang 是否安装成功，如果出现类似以下的提示即表示安装成功:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[joden@localhost otp_src_24.1]$ erl</span><br><span class="line">Erlang/OTP 24 [erts-12.1] [source] [64-bit] [smp:3:3] [ds:3:3:10] [async-threads:1]</span><br><span class="line"></span><br><span class="line">Eshell V12.1  (abort with ^G)</span><br><span class="line"><span class="meta">1&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure><h2 id="安装-Rabbit-MQ"><a href="#安装-Rabbit-MQ" class="headerlink" title="安装 Rabbit MQ"></a>安装 Rabbit MQ</h2><p>Rabbit MQ 的安装直接将下载的安装包解压到相应的目录下即可，官网下载地址: <a href="https://www.rabbitmq.com/install-generic-unix.html" target="_blank" rel="noopener">https://www.rabbitmq.com/install-generic-unix.html</a></p><p><img src="/images/other/20211009152620.png" alt="rabbit mq 下载"></p><p>这里选择将 Rabbit MQ 安装到与 Erlang 同一个目录 (/opt) 下面:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[joden@localhost workspace]$ tar -xvf rabbitmq-server-generic-unix-3.9.7.tar.xz</span><br><span class="line">[joden@localhost workspace]$ sudo mv rabbitmq_server-3.9.7/ /opt/</span><br><span class="line">[joden@localhost workspace]$ cd /opt/</span><br><span class="line">[joden@localhost opt]$ sudo mv rabbitmq_server-3.9.7/ rabbitmq</span><br></pre></td></tr></table></figure><p>同样修改/etc/profile 文件， 添加下面的环境变量:</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export RABBITMQ_HOME=/opt/rabbitmq</span><br><span class="line">export PATH=<span class="formula">$PATH:$</span>RABBITMQ_HOME/sbin</span><br></pre></td></tr></table></figure><p>执行 <code>source /etc/profile</code> 命令让配置文件生效。</p><p>验证是否安装成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[joden@localhost opt]$ rabbitmqctl version</span><br><span class="line">3.9.7</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      记录 centos7 下安装 Rabbit MQ
    
    </summary>
    
      <category term="software" scheme="http://yoursite.com/categories/software/"/>
    
    
      <category term="software" scheme="http://yoursite.com/tags/software/"/>
    
  </entry>
  
  <entry>
    <title>k8s 的 liveness 与 readiness</title>
    <link href="http://yoursite.com/2021/06/06/k8s/k8s-readiness-liveness/"/>
    <id>http://yoursite.com/2021/06/06/k8s/k8s-readiness-liveness/</id>
    <published>2021-06-06T09:33:46.000Z</published>
    <updated>2021-10-09T10:00:57.858Z</updated>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>liveness 和 readiness 是 k8s 用于健康探测的探针。</p><p>他们支持的探测方式相同，主要包括：</p><ol><li>http 探测</li><li>执行命令探测</li><li>tcp 探测</li></ol><h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><ul><li><p>liveness 主要用来确定何时重启容器</p></li><li><p>readiness 主要用来确定容器是否已经就绪。</p></li><li><p>初始值不同。</p><ul><li>liveness 的初始值为成功。这样防止在应用还没有成功启动前，就被误杀。如果在规定时间内还未成功启动，才将其设置为失败，从而触发容器重建。</li><li>readiness 的初始值为失败。这样防止应用还没有成功启动前就向应用进行流量的导入。如果在规定时间内启动成功，才将其设置为成功，从而将流量向应用导入。</li></ul></li><li><p>liveness 与 readiness 二者作用不能相互替代。</p><ul><li>只配置了 liveness，那么在容器启动，应用还没有成功就绪之前，这个时候 pod 是 ready 的（因为容器成功启动了）。那么流量就会被引入到容器的应用中，可能会导致请求失败。虽然在 liveness 检查失败后，重启容器，此时 pod 的 ready 的 condition 会变为 false。但是前面会有一些流量因为错误状态导入。</li><li>只配置了 readiness 是无法触发容器重启的。</li></ul></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/xuxinkun/p/11785521.html" target="_blank" rel="noopener">详解k8s中的liveness和readiness的原理和区别</a></p>]]></content>
    
    <summary type="html">
    
      介绍 k8s 的 liveness 与 readiness 探针
    
    </summary>
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>centos7 搭建 k8s 集群</title>
    <link href="http://yoursite.com/2021/02/27/k8s/k8s-cluster/"/>
    <id>http://yoursite.com/2021/02/27/k8s/k8s-cluster/</id>
    <published>2021-02-27T07:49:44.000Z</published>
    <updated>2021-10-09T10:00:57.857Z</updated>
    
    <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>创建三个 centos 节点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.101 k8s-master</span><br><span class="line">192.168.56.102 k8s-nnode1</span><br><span class="line">192.168.56.103 k8s-nnode2</span><br></pre></td></tr></table></figure><blockquote><p>虚拟机安装教程参考：<a href="/2021/02/27/virtualbox/centos7/centos7-network/">virtualbox 下 centos7 网络配置</a></p><font color="red">其中 master 节点需要至少 2 核 2G 配置</font></blockquote><h2 id="所有节点"><a href="#所有节点" class="headerlink" title="所有节点"></a>所有节点</h2><blockquote><p>以下操作需要在所有节点运行，这里以 master 节点为例</p></blockquote><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><blockquote><p>相应节点叫相应的名字，这里以 master 节点为例</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl <span class="built_in">set</span>-hostname k8s-master</span><br></pre></td></tr></table></figure><p>修改后重启服务器后生效</p><p><img src="/images/k8s/20210227164745.png" alt="修改主机名"></p><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227165345.png" alt="关闭防火墙"></p><h3 id="关闭防火墙自启动"><a href="#关闭防火墙自启动" class="headerlink" title="关闭防火墙自启动"></a>关闭防火墙自启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227165552.png" alt="关闭防火墙自启动"></p><h3 id="关闭-selinux"><a href="#关闭-selinux" class="headerlink" title="关闭 selinux"></a>关闭 selinux</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227165817.png" alt="关闭selinux"></p><h3 id="关闭-swap"><a href="#关闭-swap" class="headerlink" title="关闭 swap"></a>关闭 swap</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227170026.png" alt="关闭 swap"></p><p>vim /etc/fstab ，注释掉swap挂载这一行可以永久关闭swap分区</p><p><img src="/images/k8s/20210227170139.png" alt="永久关闭 swap"></p><h3 id="添加主机名与-IP-对应的关系"><a href="#添加主机名与-IP-对应的关系" class="headerlink" title="添加主机名与 IP 对应的关系"></a>添加主机名与 IP 对应的关系</h3><p>vim /etc/hosts 添加如下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.101 k8s-master</span><br><span class="line">192.168.56.102 k8s-node1</span><br><span class="line">192.168.56.103 k8s-node2</span><br></pre></td></tr></table></figure><h3 id="将桥接的-IPV4-流量传递到-iptables-的链"><a href="#将桥接的-IPV4-流量传递到-iptables-的链" class="headerlink" title="将桥接的 IPV4 流量传递到 iptables 的链"></a>将桥接的 IPV4 流量传递到 iptables 的链</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>执行完再运行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227170527.png" alt="将桥接的 IPV4 流量传递到 iptables 的链"></p><h3 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a>安装 docker</h3><ul><li><p>卸载旧的 docker</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker \</span><br><span class="line">docker-client \</span><br><span class="line">docker-client-latest \</span><br><span class="line">docker-common \</span><br><span class="line">docker-latest \</span><br><span class="line">docker-latest-logrotate \</span><br><span class="line">docker-logrotate \</span><br><span class="line">docker-engine</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227170848.png" alt="卸载旧的 docker"></p></li><li><p>安装组件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">device-mapper-persistent-data \</span><br><span class="line">lvm2</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227171119.png" alt="安装组件"></p></li><li><p>添加 docker 安装源</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager \</span><br><span class="line">--add-repo \</span><br><span class="line">https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227171215.png" alt="添加 docker 安装源"></p></li><li><p>安装 docker</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227171431.png" alt="安装 docker"></p></li><li><p>安装成功后，查看 docker 版本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker --version</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227171712.png" alt="docker 版本"></p></li><li><p>修改 Cgroupfs 为 Systemd (docker 文件驱动默认由 cgroupfs 改成 systemd，与k8s保持一致避免 conflict)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><p>内容：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>设置开机启动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227172101.png" alt="docker 自启动"></p></li><li><p>查看文件驱动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info | grep Driver</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227172215.png" alt="docker 文件驱动"></p></li></ul><h3 id="Kubernetes-yum源配置"><a href="#Kubernetes-yum源配置" class="headerlink" title="Kubernetes yum源配置"></a>Kubernetes yum源配置</h3><p><code>vim /etc/yum.repos.d/kubernetes.repo</code>，添加文件内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes Repo</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure><h3 id="安装-k8s"><a href="#安装-k8s" class="headerlink" title="安装 k8s"></a>安装 k8s</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure><ul><li><p>设置 k8s 开机启动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227172910.png" alt="k8s 开机启动"></p></li><li><p>启动 k8s 后台 daemon</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start kubelet</span><br></pre></td></tr></table></figure></li></ul><h2 id="master-节点运行"><a href="#master-节点运行" class="headerlink" title="master 节点运行"></a>master 节点运行</h2><blockquote><p>以下操作只在 master 节点运行，如果操作失败，可以通过先执行 <code>rm -rf $HOME/.kube</code> 和  <code>kubeadm reset</code> 命令来清理环境重新安装</p></blockquote><h3 id="部署-Kubernetes-Master"><a href="#部署-Kubernetes-Master" class="headerlink" title="部署 Kubernetes Master"></a>部署 Kubernetes Master</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --kubernetes-version=1.20.4  \</span><br><span class="line"> --apiserver-advertise-address=192.168.56.101   \</span><br><span class="line"> --image-repository registry.aliyuncs.com/google_containers  \</span><br><span class="line"> --service-cidr=192.168.56.0/16 --pod-network-cidr=10.122.0.0/16</span><br></pre></td></tr></table></figure><blockquote><p>apiserver-advertise-address 的地址为当前节点的 ip 地址</p><p>service-cidr 设置成当前节点的网段即可</p></blockquote><p><img src="/images/k8s/20210227204801.png" alt="部署 k8s master"></p><p><img src="/images/k8s/20210227204938.png" alt="k8s master部署"></p><p>记录生成的最后部分内容，此内容需要在其它节点加入 Kubernetes 集群之前就执行。根据 init 后的提示，创建kubectl 配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=<span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227205227.png" alt="kubectl 配置"></p><p>查看 docker 镜像：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker images</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227205420.png" alt="docker 镜像"></p><p>下面就可以直接使用 kubectl 命令了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227205905.png" alt="kubectl get node"></p><h3 id="安装-calico-网络"><a href="#安装-calico-网络" class="headerlink" title="安装 calico 网络"></a>安装 calico 网络</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227210224.png" alt="安装 calico 网络"></p><p>查看 calico 网络是否创建成功：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227210608.png" alt="calico"></p><p>再次查看 node，可以看到 master 节点状态为 ready</p><p><img src="/images/k8s/20210227210755.png" alt="master状态"></p><p>至此，k8s master节点创建完毕</p><h2 id="node-节点运行"><a href="#node-节点运行" class="headerlink" title="node 节点运行"></a>node 节点运行</h2><blockquote><p>Node 节点才需要进行的操作</p></blockquote><h3 id="node-节点加入集群"><a href="#node-节点加入集群" class="headerlink" title="node 节点加入集群"></a>node 节点加入集群</h3><p>向集群添加新节点，执行在 kubeadm init 输出的 kubeadm join 命令：复制上面命令，在 node 节点上执行在k8s-node1, k8s-node2 执行：</p><blockquote><p>token 和密钥在主节点 init 会生成</p></blockquote><p>如果忘记记录 token 和密钥，或者 token 过期了，可以通过以下命令获取（在 master 节点运行）</p><ul><li><p>先获取 token</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果过期可先执行此命令</span></span><br><span class="line">kubeadm token create    <span class="comment">#重新生成token</span></span><br><span class="line"><span class="comment">#列出token</span></span><br><span class="line">kubeadm token list  | awk -F<span class="string">" "</span> <span class="string">'&#123;print $1&#125;'</span> |tail -n 1</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227211423.png" alt="token"></p></li><li><p>获取 CA 公钥的哈希值</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed  <span class="string">'s/^ .* //'</span></span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227211528.png" alt="CA 公钥哈希值"></p></li><li><p>从节点加入集群 （k8s-node1 和 k8s-node2 执行）</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.56.101:6443 --token token填这里 --discovery-token-ca-cert-hash sha256:哈希值填这里</span><br></pre></td></tr></table></figure><blockquote><p>192.168.56.101:6443 —&gt; k8s-master 节点的 ip 和端口</p></blockquote><p>最终运行命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.56.101:6443 --token ljd4iy.mk633re8cfq42ybu --discovery-token-ca-cert-hash sha256:344376e98d61c6fb52d35ab369e13dcc49c4222972d4b5f821aea4f589fe593f</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227212205.png" alt="从节点加入集群"></p></li></ul><p>在 k8s-master 查看集群节点数：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227213819.png" alt="节点数"></p><h3 id="测试-k8s"><a href="#测试-k8s" class="headerlink" title="测试 k8s"></a>测试 k8s</h3><ul><li><p>创建 nginx 实例，并暴露端口：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">kubectl get pod,svc</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227214156.png" alt="创建 nginx 实例"></p></li><li><p>验证</p><blockquote><p>在 web 浏览器输入以下地址，会返回 nginx 欢迎界面 </p><p><a href="http://192.168.56.101:32409/" target="_blank" rel="noopener">http://192.168.56.101:32409/</a>  (该端口为上图所显示)</p><p>在 linux 节点用 curl 访问，会返回 nginx html 欢迎页面的内容</p></blockquote></li></ul><h3 id="node-节点配置-kubectl-配置"><a href="#node-节点配置-kubectl-配置" class="headerlink" title="node 节点配置 kubectl 配置"></a>node 节点配置 kubectl 配置</h3><p>如果想 node 节点也可以使用 kubectl 需要进行 master 节点复制 config 文件到 node 节点</p><p>在 k8s-node1 和 k8s-node2 节点执行以下命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo scp root@192.168.56.101:/etc/kubernetes/admin.conf /etc/kubernetes/admin.conf</span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/20210227215036.png" alt="node 节点配置 kubectl"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/jacky128256/article/details/106449237" target="_blank" rel="noopener">如何从零开始搭建一个完整的K8S集群——-基于CentOS 8系统</a></p><p><a href="https://blog.csdn.net/weixin_44208042/article/details/90676155" target="_blank" rel="noopener">kubeadm生成的token重新获取</a></p><p><a href="https://www.cnblogs.com/CoderLinkf/p/12410749.html" target="_blank" rel="noopener">CentOS7 部署K8S集群成功后，重启就不能用了？？？k8s环境自启动</a></p>]]></content>
    
    <summary type="html">
    
      介绍 centos7 下搭建 k8s 集群
    
    </summary>
    
      <category term="k8s" scheme="http://yoursite.com/categories/k8s/"/>
    
    
      <category term="k8s" scheme="http://yoursite.com/tags/k8s/"/>
    
      <category term="cluster" scheme="http://yoursite.com/tags/cluster/"/>
    
  </entry>
  
  <entry>
    <title>virtualbox 下 centos7 网络配置</title>
    <link href="http://yoursite.com/2021/02/27/virtualbox/centos7/centos7-network/"/>
    <id>http://yoursite.com/2021/02/27/virtualbox/centos7/centos7-network/</id>
    <published>2021-02-27T03:41:41.000Z</published>
    <updated>2021-10-09T10:00:57.870Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装-centos7-虚拟机"><a href="#安装-centos7-虚拟机" class="headerlink" title="安装 centos7 虚拟机"></a>安装 centos7 虚拟机</h3><ul><li><p>选中工具–点击新建–填写虚拟机名称–类型选择Linux–版本选Red Hat (64-bit)–下一步</p><p><img src="/images/virtualbox/centos7/20210227114928.png" alt="新建虚拟机"></p></li></ul><ul><li><p>设置内存大小（可以按默认来，也可以选择合适的内存大小，默认为1G），下一步</p><p><img src="/images/virtualbox/centos7/20210227115820.png" alt="设置内存大小"></p></li></ul><ul><li><p>创建虚拟硬盘，创建</p><p><img src="/images/virtualbox/centos7/20210227120035.png" alt="创建虚拟硬盘"></p></li></ul><ul><li><p>选择虚拟硬盘文件类型，再点击下一步</p><p><img src="/images/virtualbox/centos7/20210227121221.png" alt="虚拟硬盘文件类型"></p></li></ul><ul><li><p>这里选择硬盘容量动态分配，下一步</p><p><img src="/images/virtualbox/centos7/20210227121430.png" alt="动态分配硬盘容量"></p></li></ul><ul><li><p>选择合适的文件存储位置和大小，点击创建</p><p><img src="/images/virtualbox/centos7/20210227121637.png" alt="文件位置和大小"></p></li></ul><h3 id="设置虚拟机"><a href="#设置虚拟机" class="headerlink" title="设置虚拟机"></a>设置虚拟机</h3><ul><li><p>选中刚刚创建的虚拟机，点击设置</p><p><img src="/images/virtualbox/centos7/20210227122158.png" alt="设置"></p></li><li><p>设置安装镜像（去官网下载centos7的安装镜像即可，这里不进行赘述）</p><p><img src="/images/virtualbox/centos7/20210227122527.png" alt="选择安装镜像"></p><blockquote><p>可以在阿里站点下载，速度较快</p><p><a href="http://mirrors.aliyun.com/centos/7/isos/x86_64/" target="_blank" rel="noopener">http://mirrors.aliyun.com/centos/7/isos/x86_64/</a></p><p>选择CentOS-7-x86_64-Minimal-2009.iso即可，或者其他的</p></blockquote></li></ul><p>  <img src="/images/virtualbox/centos7/20210227122813.png" alt="centos7镜像"></p><ul><li><p>配置网络驱动（本文关键）</p><ul><li><p>网卡1选择默认 NAT 连接方式，并记下 MAC 地址（后续会用到）</p><p><img src="/images/virtualbox/centos7/20210227123532.png" alt="网卡1"></p></li><li><p>网卡2启用网络连接–选择 “仅主机(Host-Only)网络” 连接方式，记下 MAC 地址（后续会用到）</p><p><img src="/images/virtualbox/centos7/20210227123803.png" alt="网卡2"></p></li></ul></li></ul><ul><li><p>点击 ok 进行虚拟机启动安装即可，安装过程和普通的系统安装一样，按着提示一步步来就行</p><ul><li><p>启动进来会提示你选择启动盘，选择刚刚配置的安装镜像即可</p><p><img src="/images/virtualbox/centos7/20210227124207.png" alt=""></p></li><li><p>其余步骤不再展开</p></li></ul></li></ul><h3 id="设置联网（本文关键）"><a href="#设置联网（本文关键）" class="headerlink" title="设置联网（本文关键）"></a>设置联网（本文关键）</h3><blockquote><p>参考：<a href="https://www.jianshu.com/p/044fc0b85521" target="_blank" rel="noopener">https://www.jianshu.com/p/044fc0b85521</a></p><p>关键操作：</p><p>进入cd /etc/sysconfig/network-scripts/目录，可以看到目前只有ifcfg-enp0s3和ifcfg-enp0s8配置文件（如果安装centos7没有选择两个网卡的话，应该只有ifcfg-enp0s3 一个配置文件,如果只有一个配置文件，则另外一个就用这个copy过来改，需要更改UUID的值）</p></blockquote><p><img src="/images/virtualbox/centos7/20210227130511.png" alt="配置网络"></p><ul><li><p>编辑 ifcfg-enp0s3 设置网卡1，设置动态 ip 进行联网，使得能服务器访问外网</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi ifcfg-enp0s3</span></span><br></pre></td></tr></table></figure><p>首行添加网卡1的 MAC 地址</p><p><img src="/images/virtualbox/centos7/20210227131309.png" alt="网卡1配置"></p></li><li><p>编辑 ifcfg-enp0s8 设置网卡2，固定 ip，后续 ssh 通过此 ip 连接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi ifcfg-enp0s8</span></span><br></pre></td></tr></table></figure><p>首行添加网卡2的 MAC 地址，设置静态ip</p><p><img src="/images/virtualbox/centos7/20210227131852.png" alt="网卡2配置"></p></li><li><p>重启网络</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service network restart</span></span><br></pre></td></tr></table></figure><p><img src="/images/virtualbox/centos7/20210227132225.png" alt="重启网络"></p></li><li><p>测试验证</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ping baidu.com</span></span><br></pre></td></tr></table></figure><p>这时候要是可以上网，那设置ok，如何还是不行就继续下一步操作</p></li><li><p>先把虚拟机关闭，重新设置网卡1的连接方式</p><ul><li><p>管理–全局设定</p><p><img src="/images/virtualbox/centos7/20210227133343.png" alt="全局设定"></p></li><li><p>网络–添加 NAT 网络–OK</p><p><img src="/images/virtualbox/centos7/20210227133513.png" alt="添加NAT网络"></p></li></ul></li><li><p>选中虚拟机，点击设置，进行网卡1连接方式配置</p><p>选择 <code>NAT 网络</code> 并选择 刚刚创建的 NAT 网络 <code>NatNetwork</code> 点击 OK</p><p><img src="/images/virtualbox/centos7/20210227133824.png" alt="网卡1连接方式修改"></p></li><li><p>重新启动虚拟机再进行验证即可</p></li><li><p>假如还是无法 ping 通 baidu.com，尝试 ping 百度的 ip （可以通过一个可以上网的电脑 ping 域名获取 ip）</p><p>ip 能通但是域名无法解析，需要重新编辑 ifcfg-enp0s3 在末尾添加 DNS服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DNS1=8.8.8.8</span><br><span class="line">DNS2=114.114.114.114</span><br></pre></td></tr></table></figure><p><img src="/images/virtualbox/centos7/20210227142526.png" alt="添加dns解析服务器"></p></li><li><p>再进行测试</p><p><img src="/images/virtualbox/centos7/20210227142750.png" alt="ping"></p></li></ul>]]></content>
    
    <summary type="html">
    
      介绍 virtualbox 下 centos7 网络配置，使虚拟机内网可互相联通
    
    </summary>
    
      <category term="virtualbox" scheme="http://yoursite.com/categories/virtualbox/"/>
    
      <category term="centos7" scheme="http://yoursite.com/categories/virtualbox/centos7/"/>
    
    
      <category term="virtualbox" scheme="http://yoursite.com/tags/virtualbox/"/>
    
      <category term="centos7" scheme="http://yoursite.com/tags/centos7/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 事务隔离级别</title>
    <link href="http://yoursite.com/2020/11/05/database/mysql/transaction-isolation/"/>
    <id>http://yoursite.com/2020/11/05/database/mysql/transaction-isolation/</id>
    <published>2020-11-05T11:57:08.000Z</published>
    <updated>2021-10-09T10:00:57.853Z</updated>
    
    <content type="html"><![CDATA[<h2 id="事务基本要素"><a href="#事务基本要素" class="headerlink" title="事务基本要素"></a>事务基本要素</h2><p><img src="/images/database/mysql/acid.svg" alt="事务基本要素 ACID"></p><h2 id="事务并发几种问题"><a href="#事务并发几种问题" class="headerlink" title="事务并发几种问题"></a>事务并发几种问题</h2><p><img src="/images/database/mysql/20201105203053.png" alt="事务并发问题"></p><ul><li><p>脏读</p><p>脏读是指在一个事务处理过程里读取了另一个未提交的事务中的数据。</p><p>当一个事务正在多次修改某个数据，而在这个事务中这多次的修改都还未提交，这时一个并发的事务来访问该数据，就会造成两个事务得到的数据不一致。例如：用户A向用户B转账100元，对应SQL命令如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="keyword">account</span> <span class="keyword">set</span> money=money + <span class="number">100</span> <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'B'</span>;  (此时A通知B)</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">account</span> <span class="keyword">set</span> money=money - <span class="number">100</span> <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'A'</span>;</span><br></pre></td></tr></table></figure><p>当只执行第一条 SQL 时，A通知B查看账户，B发现确实钱已到账（此时即发生了脏读），而之后无论第二条SQL是否执行，只要该事务不提交，则所有操作都将回滚，那么当B以后再次查看账户时就会发现钱其实并没有转。</p></li><li><p>不可重复读</p><p>不可重复读是指在对于数据库中的某个数据，一个事务范围内多次查询却返回了不同的数据值，这是由于在查询间隔，被另一个事务修改并提交了。</p><p>例如事务T1在读取某一数据，而事务T2立马修改了这个数据并且提交事务给数据库，事务T1再次读取该数据就得到了不同的结果，发送了不可重复读。</p><p>不可重复读和脏读的区别是，脏读是某一事务读取了另一个事务未提交的脏数据，而不可重复读则是读取了前一事务提交的数据。</p><p>在某些情况下，不可重复读并不是问题，比如我们多次查询某个数据当然以最后查询得到的结果为主。但在另一些情况下就有可能发生问题，例如对于同一个数据A和B依次查询就可能不同，A和B就可能打起来了……</p></li><li><p>幻读</p><p>幻读是事务非独立执行时发生的一种现象。例如事务T1对一个表中所有的行的某个数据项做了从“1”修改为“2”的操作，这时事务T2又对这个表中插入了一行数据项，而这个数据项的数值还是为“1”并且提交给数据库。而操作事务T1的用户如果再查看刚刚修改的数据，会发现还有一行没有修改，其实这行是从事务T2中添加的，就好像产生幻觉一样，这就是发生了幻读。</p><p>幻读和不可重复读都是读取了另一条已经提交的事务（这点就脏读不同），所不同的是不可重复读查询的都是同一个数据项，而幻读针对的是一批数据整体（比如数据的个数）。</p></li><li><p>小结</p><p>不可重复读的和幻读很容易混淆，不可重复读侧重于<font color="red">修改</font>，幻读侧重于<font color="red">新增或删除</font>。解决不可重复读的问题只需<font color="red">锁住满足条件的行</font>，解决幻读需要<font color="red">锁表</font></p></li></ul><h2 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h2><p><img src="/images/database/mysql/20201105203602.png" alt="隔离级别"></p><h2 id="锁方式实现隔离性"><a href="#锁方式实现隔离性" class="headerlink" title="锁方式实现隔离性"></a>锁方式实现隔离性</h2><p><img src="/images/database/mysql/isolation-lock.svg" alt="锁方式实现隔离性"></p><p><a href="/images/database/mysql/isolation-lock.svg">查看原图</a></p>]]></content>
    
    <summary type="html">
    
      思维导图方式呈现 MySQL 事务隔离级别知识点
    
    </summary>
    
      <category term="database" scheme="http://yoursite.com/categories/database/"/>
    
      <category term="mysql" scheme="http://yoursite.com/categories/database/mysql/"/>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
      <category term="transaction" scheme="http://yoursite.com/tags/transaction/"/>
    
  </entry>
  
  <entry>
    <title>UML 类关系——依赖、关联、聚合、组合、泛化</title>
    <link href="http://yoursite.com/2020/10/24/uml/class-diagram-relationships/"/>
    <id>http://yoursite.com/2020/10/24/uml/class-diagram-relationships/</id>
    <published>2020-10-24T06:41:39.000Z</published>
    <updated>2021-10-09T10:00:57.869Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>类关系涉及依赖、关联、聚合、组合和泛化这五种关系，耦合度依次递增。</p><p>关于耦合度，可以简单地理解为当一个类发生变更时，对其他类造成的影响程度，影响越小则耦合度越弱，影响越大耦合度越强。</p></blockquote><h2 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h2><p><img src="/images/uml/class-diagram-relationships.svg" alt="类关系"></p><p><a href="/images/uml/class-diagram-relationships.svg">查看原图</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/k346k346/article/details/59582926" target="_blank" rel="noopener">认识 UML 类关系——依赖、关联、聚合、组合、泛化</a></p>]]></content>
    
    <summary type="html">
    
      思维导图总结依赖、关联、聚合、组合、泛化之间的关系
    
    </summary>
    
      <category term="UML" scheme="http://yoursite.com/categories/UML/"/>
    
    
      <category term="UML" scheme="http://yoursite.com/tags/UML/"/>
    
  </entry>
  
  <entry>
    <title>windows 下以local system用户运行程序</title>
    <link href="http://yoursite.com/2020/10/16/windows/run_with_local_system/"/>
    <id>http://yoursite.com/2020/10/16/windows/run_with_local_system/</id>
    <published>2020-10-16T13:52:00.000Z</published>
    <updated>2021-10-09T10:00:57.871Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近在使用 windows 服务器部署微服务的时候，启动的 java 程序经常会被无故杀死，后面经过多次验证，发现是账号被 sign off 导致以改账号启动的程序也一律被杀死了。这个时候就想到一个解决方法，把 java 程序注册成 windows 的服务运行就可以避免账号被注销而导致进程被杀死的问题了（如何注册成服务可以参照 <a href="/2020/06/03/windows/nssm_services/">nssm 注册 windows 服务</a>）。</p><p>由于涉及到的服务比较多，而且前期已经定好使用脚本启停的方式进行运维了，因此单个注册成服务需要花费的时间比较多，也不太好运维管理，那么还可以通过什么方式解决呢？</p><p>通过观察 windows 服务与我写的脚本启动服务方式的差异，不难发现，仅仅是启动账号不一样，服务是以 <a href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account" target="_blank" rel="noopener">SYSTEM</a> 用户启动的，而 SYSTEM 是最高权限的用户，因此宿主用户注销不影响以 SYSTEM 用户运行启动的程序。</p><p>那现在的问题就是该怎么以 SYSTEM 用户运行程序了。</p><h3 id="借助-PSTools-工具包以-LocalSystem-用户运行程序"><a href="#借助-PSTools-工具包以-LocalSystem-用户运行程序" class="headerlink" title="借助 PSTools 工具包以 LocalSystem 用户运行程序"></a>借助 <code>PSTools</code> 工具包以 <code>LocalSystem</code> 用户运行程序</h3><blockquote><p>可以通过该链接进行工具的下载 <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pstools" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sysinternals/downloads/pstools</a>，里面也用工具的介绍。我们主要使用到工具包中的 <code>PsExec.exe</code> （如果是64位系统也可以使用 <code>PsExec64.exe</code>）</p></blockquote><p>以 <code>LocalSystem</code> 账户运行 xxx.jar </p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe -s java -jar xxx.jar</span><br></pre></td></tr></table></figure><p><code>-s</code> 就是以 system 身份运行</p><p>还有更多可选参数例如：<code>-i</code> 以交互模式运行，就是可以看到 java 的黑窗口；<code>-d</code> 执行命令后返回，不等待命令结束。更具体的参数可以通过命令 <code>psexec /h</code> 查看</p><blockquote><p>所有的pstool第一次运行时都会弹框。可以用 <code>–accepteula</code> 这个参数</p></blockquote><h3 id="如何在当前用户下查找-LocalSystem-账号运行程序的-pid"><a href="#如何在当前用户下查找-LocalSystem-账号运行程序的-pid" class="headerlink" title="如何在当前用户下查找 LocalSystem 账号运行程序的 pid ?"></a>如何在当前用户下查找 <code>LocalSystem</code> 账号运行程序的 <code>pid</code> ?</h3><p>由于使用脚本维护各服务 jar 包的启停，那么解决了怎么以 <code>LocalSystem</code> 身份运行程序了，但是以前的脚本中使用 <code>jps -l | find &quot;xxx&quot;</code> 来查找 <code>xxx</code> 程序的 <code>pid</code> 的操作已经不再适用了，那么应该怎么替换这段脚本代码呢？</p><p>可以通过以下命令获取 <code>pid</code></p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process where "commandline like '<span class="variable">%xxx%</span>' and name='java.exe'" get processid | <span class="built_in">findStr</span> "[<span class="number">0</span>-<span class="number">9</span>]"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      在windows服务器下如何以local system账户运行指定程序？
    
    </summary>
    
      <category term="windows" scheme="http://yoursite.com/categories/windows/"/>
    
    
      <category term="windows" scheme="http://yoursite.com/tags/windows/"/>
    
      <category term="local system" scheme="http://yoursite.com/tags/local-system/"/>
    
  </entry>
  
  <entry>
    <title>nssm 注册 windows 服务</title>
    <link href="http://yoursite.com/2020/06/03/windows/nssm_services/"/>
    <id>http://yoursite.com/2020/06/03/windows/nssm_services/</id>
    <published>2020-06-03T07:56:00.000Z</published>
    <updated>2021-10-09T10:00:57.871Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在 Windows 服务器中启用 jar 应用，通常使用的命令是</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar xx.jar</span><br></pre></td></tr></table></figure><p>但是这种情况启动了，我们需要保持命令提示框的打开状态，所以萌生了个想法，要是我们将启动bat脚本注册成windows 服务是不是就可以优雅的管理我们的 java 应用了。</p><h3 id="NSSM-介绍"><a href="#NSSM-介绍" class="headerlink" title="NSSM 介绍"></a>NSSM 介绍</h3><p><strong><a href="https://nssm.cc/" target="_blank" rel="noopener">NSSM</a></strong>(the Non-Sucking Service Manager)是Windows环境下一款<strong>免安装</strong>的服务管理软件，它可以将应用封装成服务，使之像windows服务可以设置自动启动等。并且可以监控程序运行状态，程序异常中断后自动启动，实现守护进程的功能。不仅支持图形界面操作，也完全支持命令行设置。</p><h3 id="NSSM-下载与配置"><a href="#NSSM-下载与配置" class="headerlink" title="NSSM 下载与配置"></a>NSSM 下载与配置</h3><ul><li><p>进入下载界面，选择最新稳定版进行下载，<a href="https://nssm.cc/download" target="_blank" rel="noopener">https://nssm.cc/download</a></p><p><img src="/images/windows/services/20200603161326.png" alt="NSSM 下载界面"></p></li><li><p>解压到特定的目录，例如 <code>D:\nssm-2.24</code>，文件夹里面又 <code>win32</code> 和 <code>win64</code> 两个文件夹，根据系统的位数选择合适的应用，这里采用 <code>win64</code></p><p><img src="/images/windows/services/20200603161728.png" alt="nssm 目录"></p></li><li><p>配置环境变量</p><p>将 nssm 解压的路径配置到环境变量的 path 里面，如：<code>D:\nssm-2.24\win64</code></p><p><img src="/images/windows/services/20200603162145.png" alt="nssm 环境变量"></p></li><li><p>验证安装</p><p>cmd 命令窗输入 <code>nssm</code></p><p><img src="/images/windows/services/20200603162750.png" alt="nssm 验证安装"></p></li></ul><h3 id="将bat注册成服务"><a href="#将bat注册成服务" class="headerlink" title="将bat注册成服务"></a>将bat注册成服务</h3><ul><li><p>新建文件 <code>start.bat</code> 用来启动 jar 文件</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="comment">rem 启动jar</span></span><br><span class="line">java -jar xx.jar</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>新建文件 <code>install.bat</code> 用来注册服务</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="comment">rem 当前路径</span></span><br><span class="line"><span class="built_in">set</span> currpath=<span class="variable">%cd%</span></span><br><span class="line"><span class="comment">rem 服务名，自己修改</span></span><br><span class="line"><span class="built_in">set</span> servicename=xxx</span><br><span class="line"><span class="comment">rem 服务描述</span></span><br><span class="line"><span class="built_in">set</span> servicedesc=xxxx</span><br><span class="line"><span class="comment">rem 启动路径，对应start.bat路径</span></span><br><span class="line"><span class="built_in">set</span> binpath=<span class="variable">%currpath%</span>\<span class="built_in">start</span>.bat</span><br><span class="line"><span class="comment">rem 启动参数</span></span><br><span class="line"><span class="built_in">set</span> appParams=</span><br><span class="line"></span><br><span class="line"><span class="comment">rem 注册服务</span></span><br><span class="line">nssm install <span class="variable">%servicename%</span> <span class="variable">%binpath%</span></span><br><span class="line"><span class="comment">rem 修改服务描述</span></span><br><span class="line">sc description <span class="variable">%servicename%</span> <span class="variable">%servicedesc%</span></span><br><span class="line"></span><br><span class="line"><span class="comment">rem 修改注册表</span></span><br><span class="line"><span class="built_in">set</span> regpath=HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\<span class="variable">%servicename%</span>\Parameters\</span><br><span class="line"></span><br><span class="line">reg add <span class="variable">%regpath%</span> /v AppParameters /t REG_SZ /d "<span class="variable">%appParams%</span>" /f</span><br><span class="line">reg add <span class="variable">%regpath%</span>\AppExit\ /t REG_SZ /d "Ignore" /f</span><br></pre></td></tr></table></figure></li></ul><ul><li>双击 <code>install.bat</code>，即可</li></ul>]]></content>
    
    <summary type="html">
    
      介绍如何使用 nssm 注册 windows 服务
    
    </summary>
    
      <category term="windows" scheme="http://yoursite.com/categories/windows/"/>
    
      <category term="services" scheme="http://yoursite.com/categories/windows/services/"/>
    
    
      <category term="windows service" scheme="http://yoursite.com/tags/windows-service/"/>
    
      <category term="nssm" scheme="http://yoursite.com/tags/nssm/"/>
    
      <category term="服务" scheme="http://yoursite.com/tags/%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>windows 下 cronolog 进行日志切割</title>
    <link href="http://yoursite.com/2020/06/03/Java/cronolog-win/"/>
    <id>http://yoursite.com/2020/06/03/Java/cronolog-win/</id>
    <published>2020-06-03T02:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.847Z</updated>
    
    <content type="html"><![CDATA[<h3 id="软件包下载地址"><a href="#软件包下载地址" class="headerlink" title="软件包下载地址"></a>软件包下载地址</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">链接: https://pan.baidu.com/s/1xhhBKCthOxZuYBhEL4pb-Q 提取码: 9mxj</span><br></pre></td></tr></table></figure><h3 id="jar-包日志分割"><a href="#jar-包日志分割" class="headerlink" title="jar 包日志分割"></a>jar 包日志分割</h3><blockquote><p>以 springboot 的jar为例，其他 jar 包类似</p></blockquote><h4 id="windows-环境"><a href="#windows-环境" class="headerlink" title="windows 环境"></a>windows 环境</h4><ul><li><p>从上述地址👆下载对应系统的 cronolog 包</p><p><img src="/images/java/cronolog/20200603133210.png" alt="cronolog-1.6.1-win32.zip"></p></li><li><p>解压存放到指定目录，例如 <code>d:\cronolog</code></p><p><img src="/images/java/cronolog/20200603133932.png" alt=""></p></li><li><p>执行 jar 启动命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar xxx.jar | d:\cronolog\cronolog.exe 日志输出路径\xxx-%%Y%%m%%d.log</span><br></pre></td></tr></table></figure><blockquote><p>要是想后端运行可以编写bat启动脚本</p></blockquote><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line">javaw -jar xxx.jar | d:\cronolog\cronolog.exe 日志输出路径\xxx-<span class="variable">%%Y</span><span class="variable">%%m</span><span class="variable">%%d</span>.log</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="linux-环境"><a href="#linux-环境" class="headerlink" title="linux 环境"></a>linux 环境</h4><ul><li><p>下载安装包 <code>cronolog-1.6.2.tar.gz</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://cronolog.org/download/cronolog-1.6.2.tar.gz </span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">wget https://files.cnblogs.com/files/crazyzero/cronolog-1.6.2.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>解压</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf cronolog-1.6.2.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> cronolog-1.6.2</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></li><li><p>验证</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> cronolog</span><br><span class="line"><span class="comment"># 输出 /usr/local/sbin/cronolog</span></span><br></pre></td></tr></table></figure></li><li><p>执行 jar 启动命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar xxx.jar | /usr/<span class="built_in">local</span>/sbin/cronolog 日志输出路径/xxx-%Y%m%d.log</span><br></pre></td></tr></table></figure><blockquote><p>要是想后端运行可以使用以下命令</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohub java -jar xxx.jar | /usr/<span class="built_in">local</span>/sbin/cronolog 日志输出路径/xxx-%Y%m%d.log &amp;</span><br></pre></td></tr></table></figure></li></ul><h3 id="tomcat-进行日志分割"><a href="#tomcat-进行日志分割" class="headerlink" title="tomcat 进行日志分割"></a>tomcat 进行日志分割</h3><blockquote><p>这个内容网上很多资源，在此不展开说，例如：<a href="https://blog.csdn.net/fly910905/article/details/78528652" target="_blank" rel="noopener">https://blog.csdn.net/fly910905/article/details/78528652</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      在linux下我们可以使用 cronolog 对 tomcat 服务器的日志进行切割，那么在windows下是否同样可以使用 cronlog 呢？jar 包启动的方式怎么可以对日志进行切割呢？本文主要针对windows下jar包启动方式的日志 进行演示讲解，同时简要介绍一下linux系统下的操作。
    
    </summary>
    
      <category term="Java" scheme="http://yoursite.com/categories/Java/"/>
    
      <category term="cronolog" scheme="http://yoursite.com/categories/Java/cronolog/"/>
    
    
      <category term="log" scheme="http://yoursite.com/tags/log/"/>
    
      <category term="cronolog" scheme="http://yoursite.com/tags/cronolog/"/>
    
  </entry>
  
  <entry>
    <title>Windows Server 2016 搭建 FTP</title>
    <link href="http://yoursite.com/2020/02/12/windows/windows_server_2016_ftp/"/>
    <id>http://yoursite.com/2020/02/12/windows/windows_server_2016_ftp/</id>
    <published>2020-02-11T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.872Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装-WEB-服务器"><a href="#安装-WEB-服务器" class="headerlink" title="安装 WEB 服务器"></a>安装 WEB 服务器</h3><p>通过服务器添加角色和功能向导添加 <code>Web 服务器(IIS)</code></p><p>服务器管理器 —— 添加角色功能 —— Web 服务器(IIS)</p><p><img src="/images/windows/server/2016/ftp/1.png" alt="web 服务器"></p><p>下一步</p><p><img src="/images/windows/server/2016/ftp/2.png" alt="web 服务器"></p><p>下一步</p><p><img src="/images/windows/server/2016/ftp/3.png" alt="web 服务器"></p><p>下一步</p><p><img src="/images/windows/server/2016/ftp/4.png" alt="web 服务器"></p><p>选择 ftp 并且点击下一步</p><p><img src="/images/windows/server/2016/ftp/5.png" alt="web 服务器"></p><p>安装</p><p><img src="/images/windows/server/2016/ftp/6.png" alt="web 服务器"></p><p>关闭</p><p><img src="/images/windows/server/2016/ftp/7.png" alt="web 服务器"></p><h3 id="添加-FTP-站点"><a href="#添加-FTP-站点" class="headerlink" title="添加 FTP 站点"></a>添加 FTP 站点</h3><p>在 <code>计算机管理</code> 中根据提示添加即可</p><p><img src="/images/windows/server/2016/ftp/8.png" alt="FTP 站点"></p><p>填写自定义信息，下一步</p><p><img src="/images/windows/server/2016/ftp/9.png" alt="FTP 站点"></p><p>填写信息，下一步</p><p><img src="/images/windows/server/2016/ftp/10.png" alt="FTP 站点"></p><p>根据需要配置权限信息</p><p><img src="/images/windows/server/2016/ftp/11.png" alt="FTP 站点"></p><h3 id="打开IE浏览器，在Internet-选项-中设置-使用被动-FTP"><a href="#打开IE浏览器，在Internet-选项-中设置-使用被动-FTP" class="headerlink" title="打开IE浏览器，在Internet 选项 中设置 使用被动 FTP"></a>打开IE浏览器，在<code>Internet 选项</code> 中设置 <code>使用被动 FTP</code></h3><p><img src="/images/windows/server/2016/ftp/12.png" alt="Internet Options"></p><p><img src="/images/windows/server/2016/ftp/13.png" alt="Internet Options"></p><h3 id="防火墙开放端口"><a href="#防火墙开放端口" class="headerlink" title="防火墙开放端口"></a>防火墙开放端口</h3><p>在服务器管理中打开 高级安全 Windows 防火墙，点击 入站规则 —— 新建规则，根据提示添加远程端口（默认为21端口），建议将端口设置为非 21 端口。</p><p><img src="/images/windows/server/2016/ftp/14.png" alt="防火墙"></p><p><img src="/images/windows/server/2016/ftp/15.png" alt="新建规则"></p><p><img src="/images/windows/server/2016/ftp/16.png" alt="规则类型"></p><p><img src="/images/windows/server/2016/ftp/17.png" alt="指定端口"></p><p><img src="/images/windows/server/2016/ftp/18.png" alt="指定操作"></p><p><img src="/images/windows/server/2016/ftp/19.png" alt="配置文件"></p><p><img src="/images/windows/server/2016/ftp/20.png" alt="指定名称"></p><h3 id="登录验证"><a href="#登录验证" class="headerlink" title="登录验证"></a>登录验证</h3><p>在windows资源管理器中输入以下地址即可登陆：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp://ip地址:端口</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp://username:password@ip地址:端口</span><br></pre></td></tr></table></figure><p><img src="/images/windows/server/2016/ftp/21.png" alt="登录验证"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.csdn.net/h8178/article/details/78349882" target="_blank" rel="noopener">Windows Server 2016 搭建 FTP环境</a></p>]]></content>
    
    <summary type="html">
    
      从零开始在 Windows Server 2016 上搭建 FTP 服务
    
    </summary>
    
      <category term="windows" scheme="http://yoursite.com/categories/windows/"/>
    
      <category term="ftp" scheme="http://yoursite.com/categories/windows/ftp/"/>
    
    
      <category term="windows server" scheme="http://yoursite.com/tags/windows-server/"/>
    
      <category term="windows server 2016" scheme="http://yoursite.com/tags/windows-server-2016/"/>
    
      <category term="ftp" scheme="http://yoursite.com/tags/ftp/"/>
    
  </entry>
  
  <entry>
    <title>如何使用 webservice 备份报表 catalog 对象</title>
    <link href="http://yoursite.com/2019/08/24/oracle-cloud/webservice/backup-catalog-object/"/>
    <id>http://yoursite.com/2019/08/24/oracle-cloud/webservice/backup-catalog-object/</id>
    <published>2019-08-23T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.862Z</updated>
    
    <content type="html"><![CDATA[<h2 id="手动备份"><a href="#手动备份" class="headerlink" title="手动备份"></a>手动备份</h2><p>如果不是经常需要进行备份可以通过手动进行备份，没必要通过 <code>webservice</code> 备份，可以使用以下两种方式手动操作</p><ul><li>BIP: <a href="http://docs.oracle.com/cd/E28280_01/bi.1111/e22257/manage_obj_bi_pub_cat.htm#BIPUG261" target="_blank" rel="noopener">Downloading and Uploading Catalog Objects</a></li><li>OBIEE: <a href="http://docs.oracle.com/cd/E28280_01/bi.1111/e10544/mancat.htm#BIEUG321" target="_blank" rel="noopener">Archiving Objects</a></li></ul><blockquote><p>ps: 进入<code>BI Publisher</code> <code>https://xxx.com/xmlpserver</code></p></blockquote><h2 id="webservice-备份"><a href="#webservice-备份" class="headerlink" title="webservice 备份"></a>webservice 备份</h2><p>其实只是用 webservice 的方式进行 BIP 备份的两步操作</p><p>主要使用 webservice: <code>https://xxx.com/xmlpserver/services/v2/CatalogService?wsdl</code> 中的 <code>downloadObject</code> 和 <code>uploadObject</code> 或者 <code>updateObject</code></p><p>通常情况下，我们只需要调用 <code>downloadObject</code>, 获取 <code>catalog objects</code> 然后手动通过 <code>BIP</code> 界面上传还原即可完成整个备份还原流程了。简单介绍一下流程</p><h3 id="请求报文"><a href="#请求报文" class="headerlink" title="请求报文"></a>请求报文</h3><p><img src="/images/oracle_cloud/20190824172652.png" alt="payload"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Envelope</span> <span class="attr">xmlns</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">downloadObject</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.oracle.com/oxp/service/v2"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">reportAbsolutePath</span>&gt;</span>/Custom/Financials/General Ledger<span class="tag">&lt;/<span class="name">reportAbsolutePath</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">userID</span>&gt;</span>****<span class="tag">&lt;/<span class="name">userID</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">password</span>&gt;</span>***<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">downloadObject</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>reportAbsolutePath: 报表路径，假设我们要备份共享目录客制化的 <code>/Custom/Financials/General Ledger</code> 目录，填写 <code>/Custom/Financials/General Ledger</code></li><li>userID：用户名</li><li>password: 密码</li></ul><h3 id="响应报文"><a href="#响应报文" class="headerlink" title="响应报文"></a>响应报文</h3><p><img src="/images/oracle_cloud/20190824163707.png" alt="response"></p><p>通过获取的 <code>base64binary Code</code> 解密生成文件就完成了文件备份的步骤了</p><p><img src="/images/oracle_cloud/20190824172457.png" alt="base64 to file"></p><blockquote><p>测试的话可以通过 <code>https://www.hitoy.org/tool/file_base64.php</code> 在线对 <code>base64binary Code</code> 转换成文件，这里下载的是文件夹因此后缀名写 <code>xdrz</code>, 后缀名对应请往下看</p></blockquote><h3 id="文件后缀名确定"><a href="#文件后缀名确定" class="headerlink" title="文件后缀名确定"></a>文件后缀名确定</h3><p><code>catalog</code> 对象文件后缀名的对应如下，在转文件时需要使用正确的后缀名，不然 BIP 上传还原报错</p><table><thead><tr><th>Catalog Object</th><th>Extension Assigned to Downloaded Files</th></tr></thead><tbody><tr><td>Data Model</td><td>.xdmz</td></tr><tr><td>Folder</td><td>.xdrz</td></tr><tr><td>Report</td><td>.xdoz</td></tr><tr><td>Style Template</td><td>.xssz</td></tr><tr><td>Subtemplate</td><td>.xsbz</td></tr></tbody></table><h3 id="BIP-上传-catalog-对象进行还原"><a href="#BIP-上传-catalog-对象进行还原" class="headerlink" title="BIP 上传 catalog 对象进行还原"></a>BIP 上传 <code>catalog</code> 对象进行还原</h3><p>输入网址 <code>https://xxx.com/xmlpserver</code> 进入 BIP 界面</p><p>进入 <code>catalog</code>  管理界面，下图两个框框位置都可以进入</p><p><img src="/images/oracle_cloud/20190824170436.png" alt="catalog manage"></p><p>进入要还原到的目录下进行以下操作</p><p><img src="/images/oracle_cloud/20190824172916.png" alt="upload catalog"></p><p>还原成功</p><p><img src="/images/oracle_cloud/20190824173101.png" alt="success"></p><h2 id="测试结果分析"><a href="#测试结果分析" class="headerlink" title="测试结果分析"></a>测试结果分析</h2><p>后期测试发现，下载的文件夹，如果里面的内容过多（猜测是文件夹过多）会导致upload的时候失败，原因未明，另外发现通过下载上传的方式无法保留原文件的权限等设置。因此，感觉如非必要还是通过 <code>OBIEE</code> 方式进行备份吧（也就是归档与反归档）</p>]]></content>
    
    <summary type="html">
    
      本文介绍使用 oracle cloud webservice 备份报表 catalog 对象
    
    </summary>
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/categories/Oracle-Cloud/"/>
    
      <category term="webservice" scheme="http://yoursite.com/categories/Oracle-Cloud/webservice/"/>
    
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/tags/Oracle-Cloud/"/>
    
      <category term="catalog" scheme="http://yoursite.com/tags/catalog/"/>
    
  </entry>
  
  <entry>
    <title>oracle cloud 用户角色权限表关系（废弃）</title>
    <link href="http://yoursite.com/2019/08/23/oracle-cloud/user-role-privilege/"/>
    <id>http://yoursite.com/2019/08/23/oracle-cloud/user-role-privilege/</id>
    <published>2019-08-22T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.861Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>根据 sr 回复，ase相关表只是给 oracle 内部使用，表的数据并不准确，后期如果有找到相关表再做更新吧，大家看到这个直接忽略吧，打扰了</p></blockquote><h2 id="Cloud-查看用户角色权限"><a href="#Cloud-查看用户角色权限" class="headerlink" title="Cloud 查看用户角色权限"></a>Cloud 查看用户角色权限</h2><p><img src="/images/oracle_cloud/20190823222822.png" alt="Security Console"></p><p><img src="/images/oracle_cloud/20190823223248.png" alt="user role privilege"></p><h2 id="表关系"><a href="#表关系" class="headerlink" title="表关系"></a>表关系</h2><p>主要涉及表：</p><blockquote><p>前缀ASE开头的</p></blockquote><p><code>ASE_USER_VL</code>  用户表</p><p><code>ASE_USER_ROLE_MBR</code>  用户角色分配表</p><p><code>ASE_ROLE_VL</code>  角色表</p><p><code>ASE_PRIVILEGE_VL</code>  权限表</p><p><code>ASE_PRIV_ROLE_MBR</code>  权限角色表</p><p><code>ASE_ROLE_ROLE_MBR</code>  角色父子关系表</p><h2 id="sql-查询"><a href="#sql-查询" class="headerlink" title="sql 查询"></a>sql 查询</h2><h3 id="角色父子关系"><a href="#角色父子关系" class="headerlink" title="角色父子关系"></a>角色父子关系</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t.parent_role_id,</span><br><span class="line">         pr.code          <span class="keyword">AS</span> parent_role_code,</span><br><span class="line">         pr.role_name     <span class="keyword">AS</span> parent_role_name,</span><br><span class="line">         t.leaf,</span><br><span class="line">         t.ase_role_id,</span><br><span class="line">         r.code           <span class="keyword">AS</span> role_code,</span><br><span class="line">         r.role_name</span><br><span class="line">    <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> parent_role_id,</span><br><span class="line">                 <span class="keyword">connect_by_isleaf</span> leaf,</span><br><span class="line">                 <span class="keyword">connect_by_root</span>(child_role_id) ase_role_id</span><br><span class="line">            <span class="keyword">FROM</span> ase_role_role_mbr</span><br><span class="line">          <span class="keyword">CONNECT</span> <span class="keyword">BY</span> <span class="keyword">PRIOR</span> ase_role_role_mbr.parent_role_id = ase_role_role_mbr.child_role_id) t,</span><br><span class="line">         ase_role_vl pr,</span><br><span class="line">         ase_role_vl r</span><br><span class="line">   <span class="keyword">WHERE</span> t.parent_role_id = pr.role_id(+)</span><br><span class="line">     <span class="keyword">AND</span> t.ase_role_id = r.role_id</span><br></pre></td></tr></table></figure><h3 id="用户角色查询"><a href="#用户角色查询" class="headerlink" title="用户角色查询"></a>用户角色查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">WITH</span><br><span class="line"><span class="comment">-- 角色父子关系</span></span><br><span class="line">role_role_mbr_ AS</span><br><span class="line"> (<span class="keyword">SELECT</span> t.parent_role_id,</span><br><span class="line">         pr.code          <span class="keyword">AS</span> parent_role_code,</span><br><span class="line">         pr.role_name     <span class="keyword">AS</span> parent_role_name,</span><br><span class="line">         t.leaf,</span><br><span class="line">         t.ase_role_id,</span><br><span class="line">         r.code           <span class="keyword">AS</span> role_code,</span><br><span class="line">         r.role_name</span><br><span class="line">    <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> parent_role_id,</span><br><span class="line">                 <span class="keyword">connect_by_isleaf</span> leaf,</span><br><span class="line">                 <span class="keyword">connect_by_root</span>(child_role_id) ase_role_id</span><br><span class="line">            <span class="keyword">FROM</span> ase_role_role_mbr</span><br><span class="line">          <span class="keyword">CONNECT</span> <span class="keyword">BY</span> <span class="keyword">PRIOR</span> ase_role_role_mbr.parent_role_id = ase_role_role_mbr.child_role_id) t,</span><br><span class="line">         ase_role_vl pr,</span><br><span class="line">         ase_role_vl r</span><br><span class="line">   <span class="keyword">WHERE</span> t.parent_role_id = pr.role_id(+)</span><br><span class="line">     <span class="keyword">AND</span> t.ase_role_id = r.role_id),</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户角色</span></span><br><span class="line">user_role_ <span class="keyword">AS</span></span><br><span class="line"> (<span class="keyword">SELECT</span> u.user_login,</span><br><span class="line">         u.user_display_name,</span><br><span class="line">         <span class="comment">-- 与当前日期比较判断是否有效</span></span><br><span class="line">         <span class="keyword">decode</span>((<span class="keyword">SELECT</span> <span class="number">1</span></span><br><span class="line">                  <span class="keyword">FROM</span> dual</span><br><span class="line">                 <span class="keyword">WHERE</span> (u.effective_start_date &lt;= <span class="keyword">SYSDATE</span> <span class="keyword">OR</span> u.effective_start_date <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">                   <span class="keyword">AND</span> (u.effective_end_date &gt;= <span class="keyword">SYSDATE</span> <span class="keyword">OR</span> u.effective_end_date <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">                      <span class="comment">-- 使用suspend 判断是否失效</span></span><br><span class="line">                   <span class="keyword">AND</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span></span><br><span class="line">                          <span class="keyword">FROM</span> per_users pu</span><br><span class="line">                         <span class="keyword">WHERE</span> pu.user_guid = u.user_guid</span><br><span class="line">                           <span class="keyword">AND</span> pu.suspended = <span class="string">'N'</span>)),</span><br><span class="line">                <span class="number">1</span>,</span><br><span class="line">                <span class="string">'Active'</span>,</span><br><span class="line">                <span class="string">'Inactive'</span>) <span class="keyword">AS</span> is_user_active,</span><br><span class="line">         u.creation_date <span class="keyword">AS</span> user_creation_date,</span><br><span class="line">         u.last_update_date <span class="keyword">AS</span> user_last_update_date,</span><br><span class="line">         r.role_id,</span><br><span class="line">         r.code <span class="keyword">AS</span> role_code,</span><br><span class="line">         r.role_name,</span><br><span class="line">         <span class="comment">-- 与当前日期比较判断是否有效</span></span><br><span class="line">         <span class="keyword">decode</span>((<span class="keyword">SELECT</span> <span class="number">1</span></span><br><span class="line">                  <span class="keyword">FROM</span> dual</span><br><span class="line">                 <span class="keyword">WHERE</span> (r.effective_start_date &lt;= <span class="keyword">SYSDATE</span> <span class="keyword">OR</span> r.effective_start_date <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">                   <span class="keyword">AND</span> (r.effective_end_date &gt;= <span class="keyword">SYSDATE</span> <span class="keyword">OR</span> r.effective_end_date <span class="keyword">IS</span> <span class="literal">NULL</span>)),</span><br><span class="line">                <span class="number">1</span>,</span><br><span class="line">                <span class="string">'Active'</span>,</span><br><span class="line">                <span class="string">'Inactive'</span>) <span class="keyword">AS</span> is_role_active,</span><br><span class="line">         r.creation_date <span class="keyword">AS</span> role_creation_date,</span><br><span class="line">         r.last_update_date <span class="keyword">AS</span> role_last_update_date,</span><br><span class="line">         <span class="comment">-- 与当前日期比较判断是否有效</span></span><br><span class="line">         <span class="keyword">decode</span>((<span class="keyword">SELECT</span> <span class="number">1</span></span><br><span class="line">                  <span class="keyword">FROM</span> dual</span><br><span class="line">                 <span class="keyword">WHERE</span> (ur.effective_start_date &lt;= <span class="keyword">SYSDATE</span> <span class="keyword">OR</span> ur.effective_start_date <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">                   <span class="keyword">AND</span> (ur.effective_end_date &gt;= <span class="keyword">SYSDATE</span> <span class="keyword">OR</span> ur.effective_end_date <span class="keyword">IS</span> <span class="literal">NULL</span>)),</span><br><span class="line">                <span class="number">1</span>,</span><br><span class="line">                <span class="string">'Active'</span>,</span><br><span class="line">                <span class="string">'Inactive'</span>) <span class="keyword">AS</span> is_user_role_active,</span><br><span class="line">         ur.creation_date <span class="keyword">AS</span> user_role_creation_date,</span><br><span class="line">         ur.last_update_date <span class="keyword">AS</span> user_role_last_update_date</span><br><span class="line">    <span class="keyword">FROM</span> fusion.ase_user_vl       u,</span><br><span class="line">         fusion.ase_user_role_mbr ur,</span><br><span class="line">         fusion.ase_role_vl       r</span><br><span class="line">   <span class="keyword">WHERE</span> u.user_id = ur.user_id</span><br><span class="line">     <span class="keyword">AND</span> r.role_id = ur.role_id)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主查询</span></span><br><span class="line"><span class="keyword">SELECT</span> t.user_login,</span><br><span class="line">       t.user_display_name,</span><br><span class="line">       t.is_user_active,</span><br><span class="line">       t.user_creation_date,</span><br><span class="line">       t.user_last_update_date,</span><br><span class="line">       t.role_code,</span><br><span class="line">       t.role_name,</span><br><span class="line">       rr.parent_role_code,</span><br><span class="line">       rr.parent_role_name,</span><br><span class="line">       t.is_role_active,</span><br><span class="line">       t.role_creation_date,</span><br><span class="line">       t.role_last_update_date,</span><br><span class="line">       t.is_user_role_active,</span><br><span class="line">       t.user_role_creation_date,</span><br><span class="line">       t.user_role_last_update_date</span><br><span class="line">  <span class="keyword">FROM</span> user_role_     t,</span><br><span class="line">       role_role_mbr_ rr</span><br><span class="line"> <span class="keyword">WHERE</span> t.role_id = rr.ase_role_id(+)</span><br><span class="line">      <span class="comment">/* 参数 */</span></span><br><span class="line">      <span class="comment">-- 用户登陆名</span></span><br><span class="line">   <span class="keyword">AND</span> (t.user_login = :p_user <span class="keyword">OR</span> :p_user <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">      <span class="comment">-- 角色编码，包含父角色</span></span><br><span class="line">   <span class="keyword">AND</span> (:p_role_code <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">OR</span> t.role_code = :p_role_code <span class="keyword">OR</span> rr.parent_role_code = :p_role_code)</span><br><span class="line">      <span class="comment">-- 用户是否有效</span></span><br><span class="line">   <span class="keyword">AND</span> (t.is_user_active = :p_user_active <span class="keyword">OR</span> :p_user_active <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">      <span class="comment">-- 角色是否有效</span></span><br><span class="line">   <span class="keyword">AND</span> (t.is_role_active = :p_role_active <span class="keyword">OR</span> :p_role_active <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">      <span class="comment">-- 用户角色分配是否有效</span></span><br><span class="line">   <span class="keyword">AND</span> (t.is_user_role_active = :p_user_role_active <span class="keyword">OR</span> :p_user_role_active <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">      <span class="comment">-- 用户创建时间</span></span><br><span class="line">   <span class="keyword">AND</span> (t.user_creation_date &gt;= :p_user_creation_date_from <span class="keyword">OR</span> :p_user_creation_date_from <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">   <span class="keyword">AND</span> (t.user_creation_date &lt;= :p_user_creation_date_to <span class="keyword">OR</span> :p_user_creation_date_to <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">      <span class="comment">-- 角色创建时间</span></span><br><span class="line">   <span class="keyword">AND</span> (t.role_creation_date &gt;= :p_role_creation_date_from <span class="keyword">OR</span> :p_role_creation_date_from <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">   <span class="keyword">AND</span> (t.role_creation_date &lt;= :p_role_creation_date_to <span class="keyword">OR</span> :p_role_creation_date_to <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">      <span class="comment">-- 用户角色创建时间</span></span><br><span class="line">   <span class="keyword">AND</span> (t.user_role_creation_date &gt;= :p_ur_creation_date_from <span class="keyword">OR</span> :p_ur_creation_date_from <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br><span class="line">   <span class="keyword">AND</span> (t.user_role_creation_date &lt;= :p_ur_creation_date_to <span class="keyword">OR</span> :p_ur_creation_date_to <span class="keyword">IS</span> <span class="literal">NULL</span>)</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://community.oracle.com/thread/3924763?parent=MOSC_EXTERNAL&amp;sourceId=MOSC&amp;id=3924763" target="_blank" rel="noopener">https://community.oracle.com/thread/3924763?parent=MOSC_EXTERNAL&amp;sourceId=MOSC&amp;id=3924763</a></p><p><img src="/images/oracle_cloud/20190823223516.png" alt="参考"> hen</p>]]></content>
    
    <summary type="html">
    
      oracle cloud 中用户角色权限之间的表关系
    
    </summary>
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/categories/Oracle-Cloud/"/>
    
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/tags/Oracle-Cloud/"/>
    
      <category term="Role-Privileges" scheme="http://yoursite.com/tags/Role-Privileges/"/>
    
  </entry>
  
  <entry>
    <title>初识 OOM</title>
    <link href="http://yoursite.com/2019/06/20/Java/jvm/oom-1/"/>
    <id>http://yoursite.com/2019/06/20/Java/jvm/oom-1/</id>
    <published>2019-06-19T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.850Z</updated>
    
    <content type="html"><![CDATA[<h3 id="什么是-OOM"><a href="#什么是-OOM" class="headerlink" title="什么是 OOM"></a>什么是 OOM</h3><p>OOM，Out of Memory，也就是超出了预设内存。</p><blockquote><p>java.lang.OutOfMemoryError，官方说明： Thrown when the Java Virtual Machine cannot allocate an object because it is out of memory, and no more memory could be made available by the garbage collector. 意思就是说，当 JVM 没有足够的内存来为对象分配空间，并且垃圾回收器也已经没有空间可回收时，就会抛出这个error（注：非exception，因为这个问题已经严重到不足以被应用处理）。</p></blockquote><h3 id="为什么会-OOM"><a href="#为什么会-OOM" class="headerlink" title="为什么会 OOM"></a>为什么会 OOM</h3><p>主要原因有两点</p><ol><li>分配内存不足，可用通过调整启动 VM 参数控制。</li><li>程序逻辑问题，占用过多内存并且使用完没有及时释放，造成内存泄露或者内存溢出。</li></ol><p>其中：</p><ul><li><p>内存泄漏：申请使用完的内存没有释放，导致虚拟机不能再次使用该内存，此时这段内存就泄露了，因为申请者不用了，而又不能被虚拟机分配给别人用。（往往是编码不当导致）</p></li><li><p>内存溢出：申请的内存超出了JVM能提供的内存大小，此时称之为溢出。</p></li></ul><h3 id="JVM-内存模型"><a href="#JVM-内存模型" class="headerlink" title="JVM 内存模型"></a>JVM 内存模型</h3><p>上面频繁提到的内存指的就是 JVM 内存模型。</p><p>JVM 在运行会管理以下的内存区域：</p><ul><li>程序计数器：当前线程执行的字节码的<font color="red">行号指示器</font>，<font color="red">线程私有</font>，记录每个线程当前执行字节码的位置，因为会有多个线程来并发执行各种不同的代码，所有每个线程会有自己的一个程序计数器，专门记录这个线程目前执行到哪一条字节码指令，也就是线程私有；</li><li>java 虚拟机栈：保存方法内局部变量数据的区域，线程私有。线程执行了一个方法，那么就会为这个方法调用创建对应的一个<font color="red">栈帧</font>。栈帧里有这个方法的局部变量表 、操作数栈、动态链接、方法出口等东西，调用执行任何方法的时候，都会给方法创建栈帧，然后入栈，调用完再出栈；</li><li>本地方法栈：类似“java 虚拟机栈”，但是为 native 方法的运行提供内存环境，调用本地操作系统里面的一些方法，可能是调用 c 语言写的底层类库提供的内存环境；</li><li>java 堆内存：对象内存分配的地方，内存垃圾回收的主要区域，所有线程共享。对象按不同的 “生存” 情况分为新生代，老年代等；</li><li>方法区/Metaspace：JDK 1.8 后叫做 Metaspace，JDK 8 开始把类的元数据放到本地堆内存(native heap)中，这一块区域就叫 Metaspace，详情见<a href="https://www.sczyh30.com/posts/Java/jvm-metaspace/" target="_blank" rel="noopener">深入探究 JVM | 探秘 Metaspace</a>；</li><li>堆外内存：并不是 JVM 运行时数据区的一部分，可直接访问的内存，比如 NIO 会用到这部分；</li></ul><h3 id="OOM-类型"><a href="#OOM-类型" class="headerlink" title="OOM 类型"></a>OOM 类型</h3><ul><li><code>java.lang.OutOfMemoryError: Java heap space</code>，比较常见，java 堆内存溢出。详情见<a href="https://blog.csdn.net/renfufei/article/details/76350794" target="_blank" rel="noopener">OutOfMemoryError系列（1）: Java heap space</a></li><li><code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code>，程序基本上耗尽了所有的可用内存, GC也清理不了。详情见<a href="https://blog.csdn.net/renfufei/article/details/77585294" target="_blank" rel="noopener">OutOfMemoryError系列（2）: GC overhead limit exceeded</a></li><li><code>java.lang.OutOfMemoryError: PermGen space</code>，java 永久代溢出，也就是方法区溢出，jdk 7 之前。详情见<a href="https://blog.csdn.net/renfufei/article/details/77994177" target="_blank" rel="noopener">OutOfMemoryError系列（3）: Permgen space</a></li><li><code>java.lang.OutOfMemoryError: Metaspace</code>，相当于 jdk 7以前的 <code>java.lang.OutOfMemoryError: PermGen space</code>。详情见<a href="https://blog.csdn.net/renfufei/article/details/78061354" target="_blank" rel="noopener">OutOfMemoryError系列（4）: Metaspace</a></li><li><code>java.lang.StackOverflowError</code>，不会抛 OOM ERROR，但也是比较常见的 Java 内存溢出</li></ul><h3 id="查看应用进程id（pid）及启动-VM-参数"><a href="#查看应用进程id（pid）及启动-VM-参数" class="headerlink" title="查看应用进程id（pid）及启动 VM 参数"></a>查看应用进程id（pid）及启动 VM 参数</h3><p><code>jps -v</code> 查找应用进程 id </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jps -v</span><br><span class="line"></span><br><span class="line">29591 Jps -Dapplication.home=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.191.b12-1.el7_6.x86_64 -Xms8m</span><br><span class="line">9066 Bootstrap -Djava.util.logging.config.file=/xxx/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Xms512m -Xmx2048m -Djdk.tls.ephemeralDHKeySize=2048 -Xms4096m -Xmx10240m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/xxx/dump -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -Dcatalina.base=/xxx/tomcat -Dcatalina.home=/xxx/lib/tomcat -Djava.io.tmpdir=/xxx/tomcat/temp</span><br></pre></td></tr></table></figure><p><code>jinfo -flags &lt;pid&gt;</code> 查看 VM 启动参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jinfo -flags 9066</span><br><span class="line"></span><br><span class="line">Attaching to process ID 9066, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.191-b12</span><br><span class="line">Non-default VM flags: -XX:CICompilerCount=3 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=null -XX:InitialHeapSize=4294967296 -XX:MaxHeapSize=10737418240 -XX:MaxNewSize=3578789888 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=1431306240 -XX:OldSize=2863661056 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC</span><br><span class="line">Command line:  -Djava.util.logging.config.file=/xxx/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Xms512m -Xmx2048m -Djdk.tls.ephemeralDHKeySize=2048 -Xms4096m -Xmx10240m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/xxx/dump -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -Dcatalina.base=/xxx/tomcat -Dcatalina.home=/xxx/lib/tomcat -Djava.io.tmpdir=/xxx/tomcat/temp</span><br></pre></td></tr></table></figure><p><code>jmap -heap &lt;pid&gt;</code>   查看 VM 启动参数，以及堆内存情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">jmap -heap 9066</span><br><span class="line"></span><br><span class="line">Attaching to process ID 9066, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.191-b12</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 4 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 0</span><br><span class="line">   MaxHeapFreeRatio         = 100</span><br><span class="line">   MaxHeapSize              = 10737418240 (10240.0MB)</span><br><span class="line">   NewSize                  = 1431306240 (1365.0MB)</span><br><span class="line">   MaxNewSize               = 3578789888 (3413.0MB)</span><br><span class="line">   OldSize                  = 2863661056 (2731.0MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.reflect.InvocationTargetException</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">        at sun.tools.jmap.JMap.runTool(JMap.java:201)</span><br><span class="line">        at sun.tools.jmap.JMap.main(JMap.java:130)</span><br><span class="line">Caused by: java.lang.RuntimeException: unknown CollectedHeap <span class="built_in">type</span> : class sun.jvm.hotspot.gc_interface.CollectedHeap</span><br><span class="line">        at sun.jvm.hotspot.tools.HeapSummary.run(HeapSummary.java:157)</span><br><span class="line">        at sun.jvm.hotspot.tools.Tool.startInternal(Tool.java:260)</span><br><span class="line">        at sun.jvm.hotspot.tools.Tool.start(Tool.java:223)</span><br><span class="line">        at sun.jvm.hotspot.tools.Tool.execute(Tool.java:118)</span><br><span class="line">        at sun.jvm.hotspot.tools.HeapSummary.main(HeapSummary.java:50)</span><br><span class="line">        ... 6 more</span><br></pre></td></tr></table></figure><p>上面报错解决 <a href="https://stackoverflow.com/questions/20109503/exception-when-taking-a-heapdump-using-jmap" target="_blank" rel="noopener">Exception when taking a heapdump using JMAP</a></p><p>解决再运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">jmap -heap 9066</span><br><span class="line"></span><br><span class="line">Attaching to process ID 9066, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.191-b12</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 4 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 0</span><br><span class="line">   MaxHeapFreeRatio         = 100</span><br><span class="line">   MaxHeapSize              = 10737418240 (10240.0MB)</span><br><span class="line">   NewSize                  = 1431306240 (1365.0MB)</span><br><span class="line">   MaxNewSize               = 3578789888 (3413.0MB)</span><br><span class="line">   OldSize                  = 2863661056 (2731.0MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 1209532416 (1153.5MB)</span><br><span class="line">   used     = 279076032 (266.14764404296875MB)</span><br><span class="line">   free     = 930456384 (887.3523559570312MB)</span><br><span class="line">   23.073051065710338% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 112721920 (107.5MB)</span><br><span class="line">   used     = 9442424 (9.004997253417969MB)</span><br><span class="line">   free     = 103279496 (98.49500274658203MB)</span><br><span class="line">   8.376741631086482% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 109051904 (104.0MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 109051904 (104.0MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 2976907264 (2839.0MB)</span><br><span class="line">   used     = 609708576 (581.4634094238281MB)</span><br><span class="line">   free     = 2367198688 (2257.536590576172MB)</span><br><span class="line">   20.481275428806907% used</span><br><span class="line"></span><br><span class="line">67050 interned Strings occupying 6996392 bytes.</span><br></pre></td></tr></table></figure><p>获取到的 VM 参数，可关注如下几项参数的情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-XX:+HeapDumpOnOutOfMemoryError  <span class="comment"># 是否开启 OOM 时输出 dump 文件，+ 表示开启</span></span><br><span class="line">-XX:HeapDumpPath=/data/logs      <span class="comment"># 若配置该项，dump 文件输出到该路径下</span></span><br><span class="line"></span><br><span class="line">-XX:+PrintGCDetails              <span class="comment"># 是否打印 GC 详细信息</span></span><br><span class="line">-XX:+PrintGCTimeStamps           <span class="comment"># 是否打印 GC 时间戳(基准形式)</span></span><br><span class="line">-XX:+PrintGCDateStamps           <span class="comment"># 是否打印 GC 时间戳(日期形式)</span></span><br><span class="line">-XX:+PrintTenuringDistribution   <span class="comment"># 在每次新生代 GC 时，输出幸存区中对象的年龄分布</span></span><br><span class="line">-Xloggc:/data/logs               <span class="comment"># 若配置该项，GC 日志输出到该路径下</span></span><br></pre></td></tr></table></figure><p>如果应用没有启用相应的参数输出日志，可以进行以下操作查看相关日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.查看应用 GC 次数及平均每次 GC 时间</span></span><br><span class="line">jstat -gc &lt;pid&gt; 5000 <span class="comment"># 每 5 秒显示一次 pid 的进程生成 GC 情况</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查看 JVM 堆内存不同代的具体使用情况</span></span><br><span class="line">jmap -heap &lt;pid&gt; <span class="comment"># 参照上面使用</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://jluncc.github.io/2019/06/10/oom-analysis-1/" target="_blank" rel="noopener">Java OOM 分析</a></p><p><a href="https://blog.csdn.net/renfufei/article/details/76350794" target="_blank" rel="noopener">OutOfMemoryError系列</a></p><p><a href="https://www.sczyh30.com/posts/Java/jvm-metaspace/" target="_blank" rel="noopener">深入探究 JVM | 探秘 Metaspace</a></p>]]></content>
    
    <summary type="html">
    
      在进行 java 编程的时候，难免会遇到 java.lang.OutOfMemoryError (简称 OOM)，也就是程序内存不够用，这里让我们简单的了解一下 OOM。
    
    </summary>
    
      <category term="Java" scheme="http://yoursite.com/categories/Java/"/>
    
      <category term="jvm" scheme="http://yoursite.com/categories/Java/jvm/"/>
    
    
      <category term="Java" scheme="http://yoursite.com/tags/Java/"/>
    
      <category term="jvm" scheme="http://yoursite.com/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>[译文] Spring Security – security none, filters none, access permitAll</title>
    <link href="http://yoursite.com/2019/03/28/Java/spring/security-none-filters-none-access-permitAll/"/>
    <id>http://yoursite.com/2019/03/28/Java/spring/security-none-filters-none-access-permitAll/</id>
    <published>2019-03-27T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.851Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>版权说明，文章翻译至 <a href="https://www.baeldung.com/security-none-filters-none-access-permitAll" target="_blank" rel="noopener">Spring Security – security none, filters none, access permitAll</a></p></blockquote><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Spring Security 提供了几种将请求模式配置为不安全或者允许所有访问的机制。根据这些机制的不同，这可能意味着根本不在这个路径上运行安全过滤器链，或者运行了安全过滤器链但允许访问。</p><h3 id="access-”permitAll”"><a href="#access-”permitAll”" class="headerlink" title="access=”permitAll”"></a><em>access=”permitAll”</em></h3><p>给 <em>&lt;intercept-url></em> 标签设置 <em>access=”permitAll”</em> 元素，将会给指定路径<strong>允许</strong>所有请求授权:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/login*"</span> <span class="attr">access</span>=<span class="string">"permitAll"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>或者通过 java 配置:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests().antMatchers(<span class="string">"/login*"</span>).permitAll()</span><br></pre></td></tr></table></figure><p>这是在<strong>不禁用安全过滤器</strong>的情况下实现的，这些过滤器仍在运行，因此任何与 Spring Security 相关的功能仍然可以使用。</p><h3 id="filters-”none”"><a href="#filters-”none”" class="headerlink" title="filters=”none”"></a><em>filters=”none”</em></h3><p>这是在 Spring 3.1 前的功能，<strong>已在 Spring 3.1 中弃用和被替代了</strong>。</p><p>这个 filter 属性完全禁用指定的请求路径上的 Spring Security 过滤器链:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/login*"</span> <span class="attr">filters</span>=<span class="string">"none"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>当处理请求需要 Spring Security 的某些功能时，这可能会有问题。</p><p>由于在 Spring 3.0+ 版本这是一个被弃用的功能，在 Spring 3.1 中使用它将导致启动时出现运行时异常:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SEVERE: Context initialization failed</span><br><span class="line">org.springframework.beans.factory.parsing.BeanDefinitionParsingException: </span><br><span class="line">Configuration problem: The use of "filters='none'" is no longer supported. </span><br><span class="line">Please define a separate &lt;http&gt; element for the pattern you want to exclude </span><br><span class="line">and use the attribute "security='none'".</span><br><span class="line">Offending resource: class path resource [webSecurityConfig.xml]</span><br><span class="line">    at o.s.b.f.p.FailFastProblemReporter.error(FailFastProblemReporter.java:68)</span><br></pre></td></tr></table></figure><h3 id="security-”none”"><a href="#security-”none”" class="headerlink" title="security=”none”"></a><em>security=”none”</em></h3><p>正如我们在上面的错误消息中看到的那样，Spring 3.1 用一个新的表达式替换 <em>filters =“none”</em>  - <em>security =“none”</em>。</p><p>范围也发生了变化 —— 这不再在 <em>&lt;intercept-url></em> 元素级别指定。相反，Spring 3.1 允许定义多个 <em>&lt;http></em> 元素，每个元素都有自己的安全过滤链配置。因此，新的安全属性现在属于 <em>&lt;http></em> 元素级别。</p><p>在实际使用中，它长这样:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">http</span> <span class="attr">pattern</span>=<span class="string">"/resources/**"</span> <span class="attr">security</span>=<span class="string">"none"</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>或者通过 java 配置:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web.ignoring().antMatchers(<span class="string">"/resources/**"</span>);</span><br></pre></td></tr></table></figure><p>而不是旧的:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/resources/**"</span> <span class="attr">filters</span>=<span class="string">"none"</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>与 <em>filters =“none”</em> 类似，这也将完全禁用该请求路径的安全过滤器链 - 因此，当在应用程序中处理请求时，Spring Security 功能将不可用。</p><p>对于上面的示例而言，这不是问题，其主要涉及<strong>提供静态资源</strong> - 在实际中不需要做特殊处理。但是，如果以某种方式以编程方式处理请求 - 那么安全功能（例如，<em>requires-channel</em>，访问当前用户或调用安全方法）将不可用。</p><p>出于同样的原因，在已经配置了 <em>security=”none”</em> 的 <em>&lt;http></em> 元素上指定附加属性是没有意义的，因为该请求路径是不安全的，这些属性将被忽略。</p><p>或者，<em>access=’IS_AUTHENTICATED_ANONYMOUSLY’</em>  可用于允许匿名访问。</p><h3 id="Caveats-for-security-”none”"><a href="#Caveats-for-security-”none”" class="headerlink" title="Caveats for security=”none”"></a><em>Caveats for security=”none”</em></h3><p>当使用多个 <em>&lt;http></em> 元素时，有些配置了 <em>security =“none”</em>，请记住，定义这些元素的顺序很重要。我们应该首先使用特定的 <em>&lt;http></em> 路径，最后再使用通用模式。</p><p>另请注意，如果 <em>&lt;http></em> 元素<strong>未指定模式</strong>，则默认情况下，映射到通用匹配模式 - “/** ” - 因此，此元素必须是最后一个。如果元素的顺序不正确，<strong>则安全过滤器链</strong>的<strong>创建将失败</strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalArgumentException: A universal match pattern ('/**') </span><br><span class="line">is defined  before other patterns in the filter chain, causing them to be ignored. </span><br><span class="line">Please check the ordering in your &lt;security:http&gt; namespace or FilterChainProxy bean configuration</span><br><span class="line">    at o.s.s.c.h.DefaultFilterChainValidator.checkPathOrder(DefaultFilterChainValidator.java:49)</span><br><span class="line">    at o.s.s.c.h.DefaultFilterChainValidator.validate(DefaultFilterChainValidator.java:39)</span><br></pre></td></tr></table></figure><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>本文讨论了允许使用 Spring Security 访问路径的选项 - 重点关注 <strong>filters =“none”，security =“none” 和 access =“permitAll”</strong> 之间的差异。</p><p>像往常一样，这些例子可以在 <a href="https://github.com/eugenp/tutorials/tree/master/spring-security-mvc-ldap" target="_blank" rel="noopener">GitHub</a> 上找到。</p><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul><li><a href="https://www.baeldung.com/security-none-filters-none-access-permitAll" target="_blank" rel="noopener">Spring Security – security none, filters none, access permitAll</a></li></ul>]]></content>
    
    <summary type="html">
    
      Spring Security 提供了几种将请求模式配置为不安全或者允许所有访问的机制。根据这些机制的不同，这可能意味着根本不在这个路径上运行安全过滤器链，或者运行了安全过滤器链但允许访问
    
    </summary>
    
      <category term="Java" scheme="http://yoursite.com/categories/Java/"/>
    
      <category term="Spring" scheme="http://yoursite.com/categories/Java/Spring/"/>
    
    
      <category term="Java" scheme="http://yoursite.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://yoursite.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Java 代理中转下载 url 文件</title>
    <link href="http://yoursite.com/2019/03/21/Java/java-proxy-url-file/"/>
    <id>http://yoursite.com/2019/03/21/Java/java-proxy-url-file/</id>
    <published>2019-03-20T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.848Z</updated>
    
    <content type="html"><![CDATA[<h3 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h3><p>我们有一个外网访问的 java web 系统 A，这个系统会去请求一个内网系统 B 获取文件接口，这个接口会返回一个内网的下载地址给我们。假如我们只是把地址提供出去，这个时候外网是无法下载到文件的，所以我们需要在 A 系统对 B 系统返回的文件下载地址进行中转，从而暴露出基于 A 系统的外网下载地址。</p><h3 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * url 文件代理中转</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> contentType</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> fileName</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">proxyUrlFile</span><span class="params">(HttpServletResponse response, String address, String contentType, String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">     ServletOutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">     HttpURLConnection httpURLConnection = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         URL url = <span class="keyword">new</span> URL(address);</span><br><span class="line">         httpURLConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">         httpURLConnection.connect();</span><br><span class="line">         inputStream = httpURLConnection.getInputStream();</span><br><span class="line"></span><br><span class="line">         outputStream = response.getOutputStream();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">             response.setContentType(contentType);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">// 设置文件ContentType类型，这样设置，会自动判断下载文件类型</span></span><br><span class="line">             response.setContentType(<span class="string">"multipart/form-data"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (fileName != <span class="keyword">null</span>) &#123;</span><br><span class="line">             response.setHeader(<span class="string">"Content-disposition"</span>, <span class="string">"attachment; filename=\""</span></span><br><span class="line">                     + <span class="keyword">new</span> String(fileName.getBytes(<span class="string">"utf-8"</span>), <span class="string">"ISO8859-1"</span>)+<span class="string">"\""</span>);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 创建一个Buffer字符串</span></span><br><span class="line">         <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">         <span class="comment">// 每次读取的字符串长度，如果为-1，代表全部读取完毕</span></span><br><span class="line">         <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">         <span class="comment">// 使用一个输入流从buffer里把数据读取出来</span></span><br><span class="line">         <span class="keyword">while</span>((len = inputStream.read(buffer)) != -<span class="number">1</span> )&#123;</span><br><span class="line">             <span class="comment">// 用输出流往buffer里写入数据，中间参数代表从哪个位置开始读，len代表读取的长度</span></span><br><span class="line">             outputStream.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         log.error(<span class="string">"Proxy URL File error, e = &#123;&#125;"</span>, e);</span><br><span class="line">         <span class="keyword">throw</span> e;</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">             inputStream.close();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (outputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">             outputStream.flush();</span><br><span class="line">             outputStream.close();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (httpURLConnection != <span class="keyword">null</span>) &#123;</span><br><span class="line">             httpURLConnection.disconnect();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * url 文件代理中转</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/fnd/proxy/url/file"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">proxyFile</span><span class="params">(HttpServletResponse response, @RequestParam(<span class="string">"fileName"</span>)</span> String fileName, @<span class="title">RequestParam</span><span class="params">(<span class="string">"url"</span>)</span> String url) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        FileOperateUtil.proxyUrlFile(response, url, <span class="keyword">null</span>, fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      有时候由于网络问题，我们需要在服务器对别的系统内网的文件下载中转，然后暴露出外网下载地址。
    
    </summary>
    
      <category term="Java" scheme="http://yoursite.com/categories/Java/"/>
    
    
      <category term="Java" scheme="http://yoursite.com/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ADFS 安装及配置</title>
    <link href="http://yoursite.com/2019/03/11/sso/adfs/adfs-install/"/>
    <id>http://yoursite.com/2019/03/11/sso/adfs/adfs-install/</id>
    <published>2019-03-10T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.868Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h3><p>在安装 ADFS 之前，我们需要准备号 DC，参考 <a href="https://blog.joden123.top/2019/03/09/sso/adfs/adds-install/" target="_blank" rel="noopener">ADDS 活动目录安装详解</a></p><p><img src="/images/sso/adfs/adfs-install/dc.png" alt="DC"></p><h3 id="安装配置证书服务"><a href="#安装配置证书服务" class="headerlink" title="安装配置证书服务"></a>安装配置证书服务</h3><h4 id="在-DC-上安装-CA"><a href="#在-DC-上安装-CA" class="headerlink" title="在 DC 上安装 CA"></a>在 DC 上安装 CA</h4><ul><li>打开服务器管理器，点击 “添加角色和功能”</li></ul><p><img src="/images/sso/adfs/adfs-install/step1.png" alt="step 1"></p><ul><li>保持默认，并连续点击三次“下一步”</li></ul><p><img src="/images/sso/adfs/adfs-install/step2.png" alt="step 2"></p><ul><li>勾选 “Active Directory 证书服务”，然后选择添加所需的功能，最后点“下一步”继续</li></ul><p><img src="/images/sso/adfs/adfs-install/step3.png" alt="step 3"></p><ul><li>功能选择页面保持默认，连续点击2次“下一步”</li></ul><p><img src="/images/sso/adfs/adfs-install/step4.png" alt="step 4"></p><ul><li>勾选 CA 相关服务, 一直点下一步，最后点击安装</li></ul><p><img src="/images/sso/adfs/adfs-install/step5.png" alt="step 5.1"></p><ul><li>安装完成</li></ul><p><img src="/images/sso/adfs/adfs-install/step6.png" alt="step 6"></p><h4 id="配置证书服务"><a href="#配置证书服务" class="headerlink" title="配置证书服务"></a>配置证书服务</h4><ul><li>CA 安装完成后，如图点击提示图标后，选择“配置目标服务器上的 Active Directory 证书服务”</li></ul><p><img src="/images/sso/adfs/adfs-install/step7.png" alt="step 7"></p><ul><li>根据向导进行配置</li></ul><p><img src="/images/sso/adfs/adfs-install/step8.png" alt="step 8"></p><ul><li>勾选所需要配置的服务</li></ul><p><img src="/images/sso/adfs/adfs-install/step9.png" alt="step 9"></p><ul><li>选择企业根</li></ul><p><img src="/images/sso/adfs/adfs-install/step10.1.png" alt="step 10.1"></p><p><img src="/images/sso/adfs/adfs-install/step10.2.png" alt="step 10.2"></p><ul><li>创建新的私钥</li></ul><p><img src="/images/sso/adfs/adfs-install/step11.1.png" alt="step 11.1"></p><p><img src="/images/sso/adfs/adfs-install/step11.2.png" alt="step 11.2"></p><ul><li>指定 CA 名称</li></ul><p><img src="/images/sso/adfs/adfs-install/step12.png" alt="step 12"></p><ul><li>指定有效期</li></ul><p><img src="/images/sso/adfs/adfs-install/step13.png" alt="step 13"></p><ul><li>指定数据库位置</li></ul><p><img src="/images/sso/adfs/adfs-install/step14.png" alt="step 14"></p><ul><li>确认配置信息</li></ul><p><img src="/images/sso/adfs/adfs-install/step15.png" alt="step 15"></p><ul><li>配置完成</li></ul><p><img src="/images/sso/adfs/adfs-install/step16.png" alt="step 16"></p><ul><li>验证 CA</li></ul><p><img src="/images/sso/adfs/adfs-install/step17.1.png" alt="step 17.1"></p><p><img src="/images/sso/adfs/adfs-install/step17.2.png" alt="step 17.2"></p><p>以上环境准备好后就可以配置 ADFS 服务器了。在配置前我们需要给计算机或者指定的用户或者计算机授权证书颁发。</p><h3 id="安装ADFS服务"><a href="#安装ADFS服务" class="headerlink" title="安装ADFS服务"></a>安装ADFS服务</h3><p>在安装 ADFS 之前，我们需要创建和配置证书</p><h4 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h4><p>账户准备好后，然后申请证书，其实有很常见的两种方法，第一种就是通过iis进行证书申请，第二种通过 mmc 控制台进行申请，这里使用IIS的申请方法。</p><ul><li>打开IIS管理器，选择【服务器证书】<br>创建证书申请 </li></ul><p><img src="/images/sso/adfs/adfs-install/step23.1.png" alt="step 23.1"></p><p><img src="/images/sso/adfs/adfs-install/step23.2.png" alt="step 23.2"></p><p><img src="/images/sso/adfs/adfs-install/step23.3.png" alt="step 23.3"></p><p><img src="/images/sso/adfs/adfs-install/step23.4.png" alt="step 23.4"></p><p><img src="/images/sso/adfs/adfs-install/step23.5.png" alt="step 23.5"></p><p>保存到桌面上：cert.txt</p><h4 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h4><ul><li>服务器浏览器，输入 <a href="http://127.0.0.1/certsrv/" target="_blank" rel="noopener">http://127.0.0.1/certsrv/</a> 如下：</li></ul><p><img src="/images/sso/adfs/adfs-install/step24.1.png" alt="step 24.1"></p><ul><li>选择申请证书——&gt;高级证书申请 </li></ul><p><img src="/images/sso/adfs/adfs-install/step24.2.png" alt="step 24.2"></p><ul><li>选择： 使用 base64 编码的 CMC 或 PKCS #10 文件提交 一个证书申请，或使用 base64 编码的 PKCS #7 文件续订证书申请</li></ul><p><img src="/images/sso/adfs/adfs-install/step24.3.png" alt="step 24.3"></p><ul><li>打开cert.txt ，粘贴进去，证书模板选择 web服务器，提交 </li></ul><p><img src="/images/sso/adfs/adfs-install/step24.4.png" alt="step 24.4"></p><ul><li>下载证书，保存到本地：</li></ul><p><img src="/images/sso/adfs/adfs-install/step24.5.png" alt="step 24.5"></p><ul><li>回到iis管理器，选择完成证书申请</li></ul><p><img src="/images/sso/adfs/adfs-install/step24.6.png" alt="step 24.6"></p><p><img src="/images/sso/adfs/adfs-install/step24.7.png" alt="step 24.7"></p><p><img src="/images/sso/adfs/adfs-install/step24.8.png" alt="step 24.8"></p><ul><li><p>将 default web site 的 https 绑定证书改为刚才完成的证书</p><blockquote><p>选择 default web site , 右键 编辑绑定，选择 https（没有则添加） ， 点击编辑，选择 ssl 证书:（ 这个证书在安装adfs时使用该证书） </p></blockquote></li></ul><p><img src="/images/sso/adfs/adfs-install/step25.2.png" alt="step 25.2"></p><h4 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h4><ul><li>打开服务器管理器，点击 “添加角色和功能”</li></ul><p><img src="/images/sso/adfs/adfs-install/step1.png" alt="step 1"></p><ul><li>保持默认，并连续点击三次“下一步”</li></ul><p><img src="/images/sso/adfs/adfs-install/step2.png" alt="step 2"></p><ul><li>勾选 “Active Directory Federation Services” 安装服务角色</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.1.png" alt="step 26.1"></p><ul><li>功能选择页面保持默认，连续点击2次“下一步”</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.2.png" alt="step 26.2"></p><ul><li>安装</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.3.png" alt="step 26.3"></p><ul><li>安装完成</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.4.png" alt="step 26.4"></p><ul><li>ADFS 安装完成后，如图点击提示图标后，选择“在此服务器上配置联合身份验证服务”</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.5.png" alt="step 26.5"></p><ul><li>功能选择页面保持默认，连续点击2次“下一步”</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.6.png" alt="step 26.6"></p><ul><li>选择证书(不是前面创建的证书)，填写显示的名称</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.7.png" alt="step 26.7"></p><ul><li>选择 adfs 服务帐号</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.8.png" alt="step 26.8"></p><ul><li>指定配置数据库</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.10.png" alt="step 26.10"></p><ul><li>下一步</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.11.png" alt="step 26.11"></p><ul><li>配置</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.12.png" alt="step 26.12"></p><ul><li>配置完成</li></ul><p><img src="/images/sso/adfs/adfs-install/step26.13.png" alt="step 26.13"></p><p>至此 ADFS 安装配置完成</p><p><img src="/images/sso/adfs/adfs-install/step27.png" alt="step 27"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.51cto.com/gaowenlong/1920117" target="_blank" rel="noopener">Windows Server 2016 安装及配置 ADFS 4.0</a></p><p><a href="https://blog.csdn.net/xu_guowei/article/details/47781727" target="_blank" rel="noopener">Server2012 下 部署adfs IFD</a></p>]]></content>
    
    <summary type="html">
    
      本文介绍 Windows Server 2012R2 下安装接配置 ADFS。ADFS (Active Directory Federation Services) 活动目录联合服务将活动目录拓展到 Internet，当用户通过活动目录认证时，域控制器检查用户的证书。证明是合法用户后，用户就可以随意访问 Windows 网络的任何授权资源，而无需在每次访问不同服务器时重新认证。
    
    </summary>
    
      <category term="SSO" scheme="http://yoursite.com/categories/SSO/"/>
    
      <category term="ADFS" scheme="http://yoursite.com/categories/SSO/ADFS/"/>
    
    
      <category term="SSO" scheme="http://yoursite.com/tags/SSO/"/>
    
      <category term="ADFS" scheme="http://yoursite.com/tags/ADFS/"/>
    
  </entry>
  
  <entry>
    <title>ADDS 活动目录安装详解</title>
    <link href="http://yoursite.com/2019/03/09/sso/adfs/adds-install/"/>
    <id>http://yoursite.com/2019/03/09/sso/adfs/adds-install/</id>
    <published>2019-03-08T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.867Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h3><p>确保域控制器 (DC) 的计算机名符合企业命名规范，因为 AD 安装完成后再更改 DC 计算机相对复杂而且存在风险。DC 需要使用固定的静态IP地址，并且把DNS设置指向本机IP。</p><p>这台电脑 (右键) –&gt; 属性，更改设置：</p><p><img src="/images/sso/adfs/adds-install/cp-name.png" alt="computer name"></p><p>网络 (右键) –&gt; 属性 –&gt; 以太网 –&gt; 属性 –&gt; Internet 协议版本 4（TCP/IPV4） –&gt; 属性</p><p><img src="/images/sso/adfs/adds-install/network.png" alt="network"></p><h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><ul><li>打开服务器管理器，点击 “添加角色和功能”</li></ul><p><img src="/images/sso/adfs/adds-install/step1.png" alt="step 1"></p><ul><li>保持默认，并连续点击三次“下一步”。</li></ul><p><img src="/images/sso/adfs/adds-install/step2.png" alt="step 2"></p><ul><li>勾选 “ActiveDirectory域服务”，然后选择添加所需的功能，最后点“下一步”继续。</li></ul><p><img src="/images/sso/adfs/adds-install/step3.png" alt="step 3"></p><ul><li>功能选择页面保持默认，连续点击2次“下一步”。</li></ul><p><img src="/images/sso/adfs/adds-install/step4.png" alt="step 4"></p><ul><li>勾选自动重启服务器，点击“安装”。</li></ul><p><img src="/images/sso/adfs/adds-install/step5.1.png" alt="step 5.1"></p><p><img src="/images/sso/adfs/adds-install/step5.2.png" alt="step 5.2"></p><ul><li>完成ADDS安装后，如图点击提示图标后，选择“将此服务器提升为域控制器”。</li></ul><p><img src="/images/sso/adfs/adds-install/step6.png" alt="step 6"></p><ul><li>由于这是第一台域控制器(DC)，也叫林根域。选择“添加新林”，然后输入根域名。</li></ul><p><img src="/images/sso/adfs/adds-install/step7.png" alt="step 7"></p><ul><li>选择林和域功能级别，勾选DNS(AD需要高度集成DNS)，并输入目录还原模式密码。</li></ul><p><img src="/images/sso/adfs/adds-install/step8.png" alt="step 8"></p><ul><li>由于现在还没有DNS服务器，所以会提示无法创建委派。直接“下一步”。</li></ul><p><img src="/images/sso/adfs/adds-install/step9.png" alt="step 9"></p><ul><li>NetBIOS名以及ADDS数据库、日志、Sysvol保存位置，如果企业没有特殊要求，一般保持默认即可。</li></ul><p><img src="/images/sso/adfs/adds-install/step10.1.png" alt="step 10.1"></p><p><img src="/images/sso/adfs/adds-install/step10.2.png" alt="step 10.2"></p><ul><li>检查配置无误后点击“下一步”，然后点击“安装”，等待安装完成后重启即可。</li></ul><p><img src="/images/sso/adfs/adds-install/step11.1.png" alt="step 11.1"></p><p><img src="/images/sso/adfs/adds-install/step11.2.png" alt="step 11.2"></p><p>至此完成 <code>ActiveDirectory</code> 的全部安装。已经可以对外提供服务了。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.51cto.com/labixiaoniu/1253454" target="_blank" rel="noopener">Active Directory管理之一:活动目录安装详解</a></p>]]></content>
    
    <summary type="html">
    
      本文演示如何使用 windows server 2012 R2  安装 ADDS 服务
    
    </summary>
    
      <category term="SSO" scheme="http://yoursite.com/categories/SSO/"/>
    
      <category term="ADFS" scheme="http://yoursite.com/categories/SSO/ADFS/"/>
    
    
      <category term="SSO" scheme="http://yoursite.com/tags/SSO/"/>
    
      <category term="ADFS" scheme="http://yoursite.com/tags/ADFS/"/>
    
      <category term="ADDS" scheme="http://yoursite.com/tags/ADDS/"/>
    
  </entry>
  
  <entry>
    <title>[转载] 获取被代理类的真实类</title>
    <link href="http://yoursite.com/2019/03/07/Java/spring/target-class/"/>
    <id>http://yoursite.com/2019/03/07/Java/spring/target-class/</id>
    <published>2019-03-06T16:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.851Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>版权说明，文章转载自 <a href="http://imushan.com/2017/03/13/java/spring/Spring%E7%AC%94%E8%AE%B0-%E8%8E%B7%E5%8F%96%E8%A2%AB%E4%BB%A3%E7%90%86%E7%9A%84%E7%9C%9F%E5%AE%9E%E7%B1%BB/" target="_blank" rel="noopener">Spring 笔记-获取被代理的真实类</a></p></blockquote><p>对一个 <code>Autowired</code> 进来的类调用 <code>getClass</code>，发现得到的类是: <code>com.xxx.search.provider.service.SearchServiceImpl$$EnhancerBySpringCGLIB$$129db519</code>，一看就不是正经类。从名字中可以看出，这个是被代理后的类，可能因为这个类被AOP了吧。但是我在反射操作是需要原始的类的信息，要如何得到呢？</p><p><code>org.springframework.aop</code> 下有一个很重要的接口: <code>TargetClassAware</code>, 这个接口表示目前这个类是被代理的。所以我们可以通过判断一个实例是否是 <code>TargetClassAware</code> 的实例来判断他是否是一个代理类。而且 <code>TargetClassAware</code> 接口提供了 <code>getTargetClass</code> 方法来获取真实类。可以这么用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (aInstance <span class="keyword">instanceof</span> TargetClassAware) &#123;</span><br><span class="line">    aInstance.getTargetClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过更推荐的做法是使用 <code>org.springframework.aop.support.AopUtils</code> 提供的 <code>getTargetClass</code> 方法来获取真实类。可以看看其源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getTargetClass(Object candidate) &#123;</span><br><span class="line">    Assert.notNull(candidate, <span class="string">"Candidate object must not be null"</span>);</span><br><span class="line">    Class result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(candidate <span class="keyword">instanceof</span> TargetClassAware) &#123;</span><br><span class="line">        result = ((TargetClassAware)candidate).getTargetClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = isCglibProxy(candidate)?candidate.getClass().getSuperclass():candidate.getClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码首先判断当前类是否是 <code>TargetClassAware</code> 的实现，如果是，调用 <code>getTargetClass</code>，方法还判断当前类是否是 <code>CglibProxy</code>，如果是基于 <code>cglib</code> 的代理类，因为是基于继承来实现代理，所以获取父类就是真实类了。</p><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul><li><a href="http://stackoverflow.com/questions/2289211/obtain-real-class-object-for-spring-bean" target="_blank" rel="noopener">java - Obtain real Class object for Spring bean - Stack Overflow</a></li><li><a href="http://docs.spring.io/spring/docs/3.0.x/javadoc-api/org/springframework/aop/support/AopUtils.html#getTargetClass(java.lang.Object" target="_blank" rel="noopener">AopUtils</a>)</li></ul>]]></content>
    
    <summary type="html">
    
      有时候我们使用 getClass 获取到的类是被代理的类而不是真实的类，那我们是怎么获取到真实的类的呢？
    
    </summary>
    
      <category term="Java" scheme="http://yoursite.com/categories/Java/"/>
    
      <category term="Spring" scheme="http://yoursite.com/categories/Java/Spring/"/>
    
    
      <category term="Java" scheme="http://yoursite.com/tags/Java/"/>
    
      <category term="Spring" scheme="http://yoursite.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>oracle cloud 如何获取图片 url</title>
    <link href="http://yoursite.com/2019/02/20/oracle-cloud/how-to-get-image-url/"/>
    <id>http://yoursite.com/2019/02/20/oracle-cloud/how-to-get-image-url/</id>
    <published>2019-02-20T05:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.859Z</updated>
    
    <content type="html"><![CDATA[<p>以获取物料图片 <code>url</code> 作为例子</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">SELECT</span> (<span class="keyword">decode</span>(datatype_code,</span><br><span class="line">                <span class="string">'FILE'</span>,</span><br><span class="line">                (:p_host || <span class="string">'/cs/idcplg?IdcService=GET_FILE&amp;dID='</span>) || dm_version_number,</span><br><span class="line">                <span class="string">'WEB_PAGE'</span>,</span><br><span class="line">                <span class="keyword">url</span>)) <span class="keyword">AS</span> image</span><br><span class="line"> <span class="keyword">FROM</span> fnd_attached_documents d,</span><br><span class="line"> fnd_documents_vl       dv</span><br><span class="line"> <span class="keyword">WHERE</span> d.document_id = d.document_id</span><br><span class="line"> <span class="keyword">AND</span> d.entity_name = <span class="string">'ITEM_ENTITY'</span></span><br><span class="line"> <span class="keyword">AND</span> d.pk1_value = to_char(esi.organization_id)</span><br><span class="line"> <span class="keyword">AND</span> d.pk2_value = to_char(esi.inventory_item_id)</span><br><span class="line"> <span class="keyword">AND</span> <span class="keyword">rownum</span> = <span class="number">1</span>) <span class="keyword">AS</span> item_photo</span><br></pre></td></tr></table></figure><blockquote><p> 其中 <code>p_host</code> 为 <code>cloud</code> 的主域名</p></blockquote><p>其他类型的图片 <code>url</code> 可以通过变换 <code>d.entity_name = &#39;ITEM_ENTITY&#39;</code> 进行查找</p>]]></content>
    
    <summary type="html">
    
      oracle cloud 中通过附件来管理图片信息，其中图片信息可以是外链 url, 也可以是上传图片信息，cloud 生成链接信息。
    
    </summary>
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/categories/Oracle-Cloud/"/>
    
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/tags/Oracle-Cloud/"/>
    
      <category term="attachment" scheme="http://yoursite.com/tags/attachment/"/>
    
  </entry>
  
  <entry>
    <title>如何获取 oracle cloud 的 PO 的 shipping method</title>
    <link href="http://yoursite.com/2019/02/20/oracle-cloud/po/how-to-get-shipping-method/"/>
    <id>http://yoursite.com/2019/02/20/oracle-cloud/po/how-to-get-shipping-method/</id>
    <published>2019-02-20T04:00:00.000Z</published>
    <updated>2021-10-09T10:00:57.861Z</updated>
    
    <content type="html"><![CDATA[<h3 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h3><blockquote><p>Oracle Cloud Application 19B (11.13.19.04.0)</p></blockquote><h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><ul><li>获取 po 头上的 shipping method</li></ul><p><img src="/images/oracle_cloud/20190826222844.png" alt="po head shipping method"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> po_bip_helper.get_shipping_method(carrierpartyname.party_name,</span><br><span class="line">                                         modeoftransportlookuppeo.meaning,</span><br><span class="line">                                         servicelevellookuppeo.meaning) <span class="keyword">AS</span> shippingmethod</span><br><span class="line">  <span class="keyword">FROM</span> wsh_carriers   carrier,</span><br><span class="line">       hz_parties     carrierpartyname,</span><br><span class="line">       fnd_lookups    modeoftransportlookuppeo,</span><br><span class="line">       fnd_lookups    servicelevellookuppeo,</span><br><span class="line">       po_headers_all header</span><br><span class="line"> <span class="keyword">WHERE</span> (header.mode_of_transport = modeoftransportlookuppeo.lookup_code(+) <span class="keyword">AND</span> modeoftransportlookuppeo.lookup_type(+) = <span class="string">'WSH_MODE_OF_TRANSPORT'</span>)</span><br><span class="line">   <span class="keyword">AND</span> (header.service_level = servicelevellookuppeo.lookup_code(+) <span class="keyword">AND</span> servicelevellookuppeo.lookup_type(+) = <span class="string">'WSH_SERVICE_LEVELS'</span>)</span><br><span class="line">   <span class="keyword">AND</span> header.carrier_id = carrier.carrier_id(+)</span><br><span class="line">   <span class="keyword">AND</span> carrier.carrier_id = carrierpartyname.party_id(+)</span><br><span class="line">   <span class="keyword">AND</span> header.segment1 = <span class="string">'20000028'</span></span><br></pre></td></tr></table></figure><ul><li>获取 po 行上的 shipping method</li></ul><p><img src="/images/oracle_cloud/20190826223054.png" alt="po line shipping method"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> po_bip_helper.get_shipping_method(carrierpartyname.party_name,</span><br><span class="line">                                         modeoftransportlookuppeo.meaning,</span><br><span class="line">                                         servicelevellookuppeo.meaning) <span class="keyword">AS</span> shippingmethod</span><br><span class="line">  <span class="keyword">FROM</span> wsh_carriers          carrier,</span><br><span class="line">       hz_parties            carrierpartyname,</span><br><span class="line">       fnd_lookups           modeoftransportlookuppeo,</span><br><span class="line">       fnd_lookups           servicelevellookuppeo,</span><br><span class="line">       po_line_locations_all plla</span><br><span class="line"> <span class="keyword">WHERE</span> (plla.mode_of_transport = modeoftransportlookuppeo.lookup_code(+) <span class="keyword">AND</span> modeoftransportlookuppeo.lookup_type(+) = <span class="string">'WSH_MODE_OF_TRANSPORT'</span>)</span><br><span class="line">   <span class="keyword">AND</span> (plla.service_level = servicelevellookuppeo.lookup_code(+) <span class="keyword">AND</span> servicelevellookuppeo.lookup_type(+) = <span class="string">'WSH_SERVICE_LEVELS'</span>)</span><br><span class="line">   <span class="keyword">AND</span> plla.carrier_id = carrier.carrier_id(+)</span><br><span class="line">   <span class="keyword">AND</span> carrier.carrier_id = carrierpartyname.party_id(+)</span><br><span class="line">   <span class="keyword">AND</span> plla.po_header_id = pla.po_header_id</span><br><span class="line">   <span class="keyword">AND</span> plla.po_line_id = pla.po_line_id</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Oracle Cloud PO 界面上显示的 shipping method 在后台是通过几个字段来存储的，要获取该字段得使用函数获取。
    
    </summary>
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/categories/Oracle-Cloud/"/>
    
      <category term="PO" scheme="http://yoursite.com/categories/Oracle-Cloud/PO/"/>
    
    
      <category term="Oracle Cloud" scheme="http://yoursite.com/tags/Oracle-Cloud/"/>
    
      <category term="PO" scheme="http://yoursite.com/tags/PO/"/>
    
  </entry>
  
</feed>
